---
ID: 194
post_title: >
  Bending the code generation of
  IExtenderProvider to your will
author: timvw
post_date: 2007-08-21 19:15:24
post_excerpt: ""
layout: post
permalink: >
  http://www.timvw.be/2007/08/21/bending-the-code-generation-of-iextenderprovider-to-your-will/
published: true
---
<p>In <a href="http://www.timvw.be/exploring-codedomserializer/">Exploring CodeDomSerializer</a> i already explained how we can modify the code that the Visual Studio designer generates for us. With a typical <a href="http://msdn2.microsoft.com/en-us/library/system.componentmodel.iextenderprovider.aspx">IExtenderProvider</a> the designer generates an initializer, SetXXX methods and a variable declaration, which looks like:</p>

[code lang="csharp"]this.constantsExtenderProvider1 = new WindowsApplication1.ConstantsExtenderProvider();

this.constantsExtenderProvider1.SetConstants(this.button1, new string[] {
 "Operation1",
 "Operation5"});

this.constantsExtenderProvider1.SetConstants(this, null);

private ConstantsExtenderProvider constantsExtenderProvider1;[/code]

<p>Now, what if we're not happy with those generated SetXXX methods on each Component? The problem is that this code is not generated by the serializer for the ConstantsExtenderProvider but by the serializers for the Components. An easy workaround for this problem is to set the <a href="http://msdn2.microsoft.com/en-us/library/system.componentmodel.designerserializationvisibilityattribute.aspx">DesignerSerializationVisibilityAttribute</a> on the GetXXX method in our IExtenderProvider to <a href="http://msdn2.microsoft.com/en-us/library/system.componentmodel.designerserializationvisibility.aspx">Hidden</a>.</p>

<p>With those ugly SetXXX methods out of the way it's up to us to do it better. We do this by implementing a custom serializer for our ConstantsExtenderProvider:</p>

[code lang="csharp"]class ConstantsSerializer<t> : CodeDomSerializer
{
 public override object Serialize(IDesignerSerializationManager manager, object value)
 {
  ConstantsExtenderProvider provider = value as ConstantsExtenderProvider;

  CodeDomSerializer baseClassSerializer = manager.GetSerializer(typeof(ConstantsExtenderProvider).BaseType, typeof(CodeDomSerializer)) as CodeDomSerializer;
  CodeStatementCollection statements = baseClassSerializer.Serialize(manager, value) as CodeStatementCollection;

  IDesignerHost host = (IDesignerHost)manager.GetService(typeof(IDesignerHost));
  ComponentCollection components = host.Container.Components;
  this.SerializeExtender(manager, provider, components, statements);

  return statements;
 }

 private void SerializeExtender(IDesignerSerializationManager manager, ConstantsExtenderProvider provider, ComponentCollection components, CodeStatementCollection statements)
 {
  foreach (IComponent component in components)
  {
   Control control = component as Control;
   if (control != null && (control as Form == null))
   {
    CodeMethodInvokeExpression methodcall = new CodeMethodInvokeExpression(base.SerializeToExpression(manager, provider), "SetConstants");
    methodcall.Parameters.Add(new CodeFieldReferenceExpression(new CodeThisReferenceExpression(), control.Name));

    string[] constants = provider.GetConstants(control);
    if (constants != null)
    {
     StringBuilder sb = new StringBuilder();
     sb.Append("new string[] { ");

     foreach (string constant in constants)
     {
      sb.Append(typeof(T).FullName);
      sb.Append(".");
      sb.Append(constant);
      sb.Append(", ");
     }

     sb.Remove(sb.Length - 2, 2);
     sb.Append(" }");

     methodcall.Parameters.Add(new CodeSnippetExpression(sb.ToString()));
    }
    else
    {
     methodcall.Parameters.Add(new CodePrimitiveExpression(null));
    }

    statements.Add(methodcall);
   }
  }
 }
}[/code]

<p>And now the generated code looks like:</p>

[code lang="csharp"]this.constantsExtenderProvider1.SetConstants(this.button1, new string[] { WindowsApplication1.Constants.Operation1, WindowsApplication1.Constants.Operation5 });[/code]

<p>As always, feel free to download the <a href="http://www.timvw.be/wp-content/code/csharp/ConstantsExtenderProvider.zip">ConstantsExtenderProvider</a> source.</p>