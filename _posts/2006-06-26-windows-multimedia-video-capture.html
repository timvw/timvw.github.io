---
layout: post
status: publish
published: true
title: Windows Multimedia Video Capture
author:
  display_name: timvw
  login: admin
  email: tim@timvw.be
  url: http://timvw.myopenid.com/
author_login: admin
author_email: tim@timvw.be
author_url: http://timvw.myopenid.com/
wordpress_id: 51
wordpress_url: http://www.timvw.be/windows-multimedia-video-capture/
date: '2006-06-26 21:10:26 +0200'
date_gmt: '2006-06-26 19:10:26 +0200'
categories: []
tags:
- C#
- Windows Forms
comments:
- id: 25
  author: Nathan
  author_email: 2221276@uwc.ac.za
  author_url: ''
  date: '2007-10-01 19:38:33 +0200'
  date_gmt: '2007-10-01 17:38:33 +0200'
  content: |-
    hi tim
    im trying to view your capture program but i keep on getting the same errors, any idea why?
    errors are:
    testavicap32.csproj not istalled
    pinvoke.csproj not installed
    thanks for your help
- id: 26
  author: timvw
  author_email: timvanwassenhove@gmail.com
  author_url: http://www.timvw.be
  date: '2007-10-01 19:47:32 +0200'
  date_gmt: '2007-10-01 17:47:32 +0200'
  content: It seems that you'll have to perform a websearch for "csproj not installed"...
    (At first sight it seems that you haven't install a visual studio edition that
    is capable of handling c# projects)
- id: 27
  author: Martin
  author_email: martin_enyenks@yahoo.co.uk
  author_url: ''
  date: '2007-12-24 11:14:54 +0100'
  date_gmt: '2007-12-24 09:14:54 +0100'
  content: |-
    Hi, tim.

    Thanks for the source. One thing I want to ask you. Is it possible to use this source to capture from tv tuner?
- id: 28
  author: Jack
  author_email: jack.colebrook@dyson.com
  author_url: ''
  date: '2008-02-08 17:01:58 +0100'
  date_gmt: '2008-02-08 15:01:58 +0100'
  content: |-
    Hi Tim

    Is it possible to change the height and width of the captured image? Currently its set at 240x320.

    Thanks for the help
    Jack
- id: 29
  author: Gonzalo
  author_email: gonzaloruizf@gmail.com
  author_url: ''
  date: '2008-02-22 15:55:34 +0100'
  date_gmt: '2008-02-22 13:55:34 +0100'
  content: |-
    Same question as the last one. Is it possible to change the height and width of the captured image? How is this set? Because I'm currently capturing at 480x360.

    Thanks in advance.
- id: 30
  author: timvw
  author_email: timvanwassenhove@gmail.com
  author_url: http://www.timvw.be
  date: '2008-02-22 18:18:23 +0100'
  date_gmt: '2008-02-22 16:18:23 +0100'
  content: |-
    <p>Hello, although i'm not proud of the code i posted back then (could use a refactoring, but i don't feel like doing that) It is possible to achieve this... Add the following Constants and Structures to Pinvoke&#47;Class1.cs<&#47;p>

    [code lang="csharp"]
    &#47;&#47;&#47; <see cref="http:&#47;&#47;www.pinvoke.net&#47;default.aspx&#47;Constants.WM"&#47;>
    public class Constants
    {
     public const uint WM_CAP = 0x400;
     public const uint WM_CAP_DRIVER_CONNECT = 0x40a;
     public const uint WM_CAP_DRIVER_DISCONNECT = 0x40b;
     public const uint WM_CAP_EDIT_COPY = 0x41e;
     public const uint WM_CAP_SET_PREVIEW = 0x432;
     public const uint WM_CAP_SET_OVERLAY = 0x433;
     public const uint WM_CAP_SET_PREVIEWRATE = 0x434;
     public const uint WM_CAP_SET_SCALE = 0x435;
     public const uint WS_CHILD = 0x40000000;
     public const uint WS_VISIBLE = 0x10000000;
     public const uint WM_CAP_DLG_VIDEODISPLAY = WM_CAP + 43;
     public const uint WM_CAP_SET_VIDEOFORMAT = WM_CAP + 45;
    }

    [StructLayout(LayoutKind.Sequential)]
    public struct BitMapInfoHeader
    {
     public uint biSize;
     public int biWidth;
     public int biHeight;
     public ushort biPlanes;
     public ushort biBitCount;
     public uint biCompression;
     public uint biSizeImage;
     public int biXPelsPerMeter;
     public int biYPelsPerMeter;
     public uint biClrUsed;
     public uint biClrImportant;
    }

    [StructLayout(LayoutKind.Sequential)]
    public struct BitMapInfo
    {
     public BitMapInfoHeader bmiHeader;
     public int bmiColors;
    }
    [&#47;code]

    <p>And add the following method to the User32 class in Pinvoke&#47;Class1.cs:<&#47;p>
    [code lang="csharp"]
    [DllImport("user32", EntryPoint = "SendMessage")]
    public static extern IntPtr SendMessage(
     IntPtr hWnd,
     uint Msg,
     int wParam,
     ref BitMapInfo lParam
    );
    [&#47;code]
    <p>Modify the Attach method in TestAviCap&#47;CaptureDevice.cs as following:<&#47;p>
    [code lang="csharp"]
    public void Attach(System.Windows.Forms.Control control)
    {
     deviceHandle = Avicap32.capCreateCaptureWindow("", Constants.WS_VISIBLE | Constants.WS_CHILD, 0, 0, control.Width, control.Height, control.Handle, 0);

     if (User32.SendMessage(deviceHandle, Constants.WM_CAP_DRIVER_CONNECT, (IntPtr)deviceNumber, (IntPtr)0).ToInt32() > 0)
     {
      User32.SendMessage(deviceHandle, Constants.WM_CAP_SET_SCALE, (IntPtr)(-1), (IntPtr)0);
      User32.SendMessage(deviceHandle, Constants.WM_CAP_SET_PREVIEWRATE, (IntPtr)0x42, (IntPtr)0);
      User32.SendMessage(deviceHandle, Constants.WM_CAP_SET_PREVIEW, (IntPtr)(-1), (IntPtr)0);

      BitMapInfo bInfo = new BitMapInfo();
      bInfo.bmiHeader = new BitMapInfoHeader();
      bInfo.bmiHeader.biSize = (uint)Marshal.SizeOf(bInfo.bmiHeader);
      bInfo.bmiHeader.biWidth = 800;
      bInfo.bmiHeader.biHeight = 600;
      bInfo.bmiHeader.biPlanes = 1;
      bInfo.bmiHeader.biBitCount = 24;
      User32.SendMessage(deviceHandle, Constants.WM_CAP_SET_VIDEOFORMAT, Marshal.SizeOf(bInfo), ref bInfo);
      User32.SetWindowPos(deviceHandle, new IntPtr(0), 0, 0, control.Width, control.Height, 6);
     }
    }
    [&#47;code]
- id: 487
  author: jibin
  author_email: jibin.mn@gmail.com
  author_url: ''
  date: '2010-09-16 08:43:09 +0200'
  date_gmt: '2010-09-16 07:43:09 +0200'
  content: "HI, \r\ni am using the code from your \"testavicap32.zip\"  for playing
    with webcam and able to run the code successfully in the system..\r\nBut the application
    shows only a black screen while i am running on a laptop with inbuilt camera(windows
    7 )..in another lap (windows 7) it shows only one frame then no more ..but in
    both cases the application is picking the images from USB cams without any pblms.Any
    idea"
- id: 2310
  author: Miglans
  author_email: tomek.monopolek@interia.pl
  author_url: http://www_sterup.terazwww.pl/
  date: '2010-12-25 23:02:14 +0100'
  date_gmt: '2010-12-25 22:02:14 +0100'
  content: "Yes. I have:\r\n\r\n1. Turn on program with code. (black screan)\r\n2.
    Turn on the Skype, setting,  and run Test WebCam. Program changed collor to green.\r\n3.
    Stopt the WebCam test. Program then show your face ;)\r\nBye"
- id: 2312
  author: Miglans
  author_email: tomek.monopolek@interia.pl
  author_url: http://www_sterup.terazwww.pl/
  date: '2010-12-25 23:26:05 +0100'
  date_gmt: '2010-12-25 22:26:05 +0100'
  content: "sorryy... this wey is good\r\n\r\n1. Turn on the Skype, setting, and run
    Test WebCam. \r\n2.  Turn on program with code. (green screan)\r\n3. Stopt the
    WebCam test. Program then show your face ;)\r\nBye"
- id: 6206
  author: Jason Rettinghaus
  author_email: jasonr@ghtool.com
  author_url: ''
  date: '2011-03-07 16:31:15 +0100'
  date_gmt: '2011-03-07 15:31:15 +0100'
  content: "I am trying to use this code in my VB.Net project.  I have converted it
    over, but am still having issues.  Do you have a working VB example of this that
    I can look at?\r\n\r\nThanks,\r\nJason"
- id: 157708
  author: How to stop video source dialog appearing in windows 7?
  author_email: ''
  author_url: http://hitesh9om@gmail.com
  date: '2013-01-17 11:08:52 +0100'
  date_gmt: '2013-01-17 10:08:52 +0100'
  content: "Dear Sir,\r\nYour code is running well .we can open the web cam in windows
    7 but one major issues is that video source dialog box is appears each time when
    we press the start to capture. Is there any way to stop this dialog box? So that
    we can capture image directly without selecting the camera.\r\nWe have application
    which works well in windows xp no dialog box appears but the same application
    in windows 7 gives the video source dialog box.\r\nPlease give some suggestion
    to solve the above issue.\r\nThanks in advance.\r\n-Hitesh"
---
<p>On my computer the <a href="http:&#47;&#47;msdn.microsoft.com&#47;library&#47;default.asp?url=&#47;library&#47;en-us&#47;wia&#47;wia&#47;overviews&#47;startpage.asp">WIA (Windows Image Acquisition)<&#47;a> API is SLOOOOOW. So i decided to give the <a href="http:&#47;&#47;windowssdk.msdn.microsoft.com&#47;en-us&#47;library&#47;ms713477(VS.80).aspx">Windows Multimedia Video Capture<&#47;a> API a try. I didn't take long to <a href="http:&#47;&#47;msdn.microsoft.com&#47;library&#47;default.asp?url=&#47;library&#47;en-us&#47;cpguide&#47;html&#47;cpconcreatingprototypesinmanagedcode.asp">create the prototypes in Managed Code<&#47;a> and <a href="http:&#47;&#47;msdn.microsoft.com&#47;library&#47;en-us&#47;cpguide&#47;html&#47;cpconcallingdllfunction.asp">call the DLL functions<&#47;a>. Everything runs really smooth now... As always, feel free to download the <a href="http:&#47;&#47;www.timvw.be&#47;wp-content&#47;code&#47;csharp&#47;testavicap32.zip">testavicap32<&#47;a> sources now!<&#47;p></p>
