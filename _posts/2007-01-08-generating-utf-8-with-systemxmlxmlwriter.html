---
layout: post
status: publish
published: true
title: Generating UTF-8 with System.Xml.XmlWriter
author:
  display_name: timvw
  login: admin
  email: tim@timvw.be
  url: http://timvw.myopenid.com/
author_login: admin
author_email: tim@timvw.be
author_url: http://timvw.myopenid.com/
wordpress_id: 143
wordpress_url: http://www.timvw.be/generating-utf-8-with-systemxmlxmlwriter/
date: '2007-01-08 23:59:44 +0100'
date_gmt: '2007-01-08 21:59:44 +0100'
categories: []
tags:
- XML
- C#
comments:
- id: 98
  author: Martin
  author_email: ''
  author_url: ''
  date: '2007-02-06 15:21:36 +0100'
  date_gmt: '2007-02-06 13:21:36 +0100'
  content: Good job...
- id: 99
  author: Maciek
  author_email: ''
  author_url: ''
  date: '2007-02-13 11:47:29 +0100'
  date_gmt: '2007-02-13 09:47:29 +0100'
  content: |-
    Good job, really...
    Maybe you should use ToArray instead of GetBuffer in the last line
- id: 100
  author: admin
  author_email: ''
  author_url: ''
  date: '2007-02-13 11:48:30 +0100'
  date_gmt: '2007-02-13 09:48:30 +0100'
  content: |-
    <blockquote>
    Maybe you should use ToArray instead of GetBuffer in the last line
    <&#47;blockquote>

    When i wrote that code i also discovered <a href="http:&#47;&#47;weblogs.asp.net&#47;rosherove&#47;archive&#47;2003&#47;10&#47;07&#47;30835.aspx" rel="nofollow">[Tip]:MemoryStream.GetBuffer() vs. MemoryStream.ToArray()<&#47;a>.. And i decided that i should use reflector to check if this behaviour still exists, but i never did it (and as long i don't run into weird problems i'll be probably too lazy to investigate it..) Anyway, as soon as this bites you, you indeed may want to use ToArray intead.

    <b>EDIT (18&#47;12&#47;2007) Well, reviewing this comment, earlier this year it did bite me.. Somehow the buffer was larger than the actual number of bytes so i ended up with a couple of 0 values at the end.. Which is undesirable. Therefor, i will consistently use ToArray from now on :)<&#47;b>
- id: 101
  author: Coen B
  author_email: coenb@xs4all.nl
  author_url: ''
  date: '2007-02-14 19:13:46 +0100'
  date_gmt: '2007-02-14 17:13:46 +0100'
  content: Thanks a million!
- id: 102
  author: oykica
  author_email: ''
  author_url: ''
  date: '2007-02-28 03:13:56 +0100'
  date_gmt: '2007-02-28 01:13:56 +0100'
  content: Thanks a lot. This really helped me out.
- id: 103
  author: Steve B
  author_email: boardman_steve@hotmail.com
  author_url: ''
  date: '2007-12-17 17:09:21 +0100'
  date_gmt: '2007-12-17 15:09:21 +0100'
  content: Helped a lot. Thanks! I find it strange that UTF8.GetString() can't cope
    with the BOM at the start of the array it's decoding - especially when the BOM
    is optional when writing the XML with XmlWriter!
- id: 104
  author: Taras
  author_email: ''
  author_url: ''
  date: '2007-12-24 15:53:30 +0100'
  date_gmt: '2007-12-24 13:53:30 +0100'
  content: Thanks! Just what I need!
- id: 105
  author: Chris
  author_email: ''
  author_url: ''
  date: '2008-06-07 19:39:17 +0200'
  date_gmt: '2008-06-07 17:39:17 +0200'
  content: Fantastic resource! That's for the work on this.
- id: 106
  author: Pavel
  author_email: p.ershov@gmail.com
  author_url: ''
  date: '2008-08-21 21:03:13 +0200'
  date_gmt: '2008-08-21 19:03:13 +0200'
  content: Great article, which has saved much time for me! Thanks!
- id: 107
  author: miraj
  author_email: ''
  author_url: ''
  date: '2008-11-18 20:46:20 +0100'
  date_gmt: '2008-11-18 18:46:20 +0100'
  content: excellent!! problem easily solved......thanks
- id: 108
  author: Dino
  author_email: ''
  author_url: http://www.softactivity.com/blog/
  date: '2008-12-12 04:15:27 +0100'
  date_gmt: '2008-12-12 02:15:27 +0100'
  content: Thank you! this article helped me to save XML as UTF-8
- id: 109
  author: Ray
  author_email: askrayparker@gmail.com
  author_url: ''
  date: '2009-04-16 12:14:06 +0200'
  date_gmt: '2009-04-16 11:14:06 +0200'
  content: Thanks, helped me.
- id: 110
  author: Matze
  author_email: ''
  author_url: ''
  date: '2009-08-03 13:50:15 +0200'
  date_gmt: '2009-08-03 12:50:15 +0200'
  content: Thanks, great job!
- id: 632
  author: Alexis
  author_email: alexisatkinson@hotmail.com
  author_url: ''
  date: '2010-09-21 13:48:35 +0200'
  date_gmt: '2010-09-21 12:48:35 +0200'
  content: "This helped me out.  Thanks!\r\n\r\nBTW, this behaviour still exists in
    .net 4."
- id: 44741
  author: Aaron
  author_email: aaron@kingdango.com
  author_url: ''
  date: '2012-05-01 21:29:50 +0200'
  date_gmt: '2012-05-01 20:29:50 +0200'
  content: Seriously great stuff, thank you!
- id: 178257
  author: Dennis
  author_email: dennis.devlin@cognex.com
  author_url: ''
  date: '2013-02-27 17:22:25 +0100'
  date_gmt: '2013-02-27 16:22:25 +0100'
  content: And 6 years later, it is still helping.  Thanks for this!
- id: 266449
  author: Paul
  author_email: ''
  author_url: ''
  date: '2013-10-10 15:57:14 +0200'
  date_gmt: '2013-10-10 14:57:14 +0200'
  content: "6,5 years later. Still helped someone!\r\n\r\nThanks alot!"
- id: 312173
  author: Fabio
  author_email: fabiobernalt@outlook.com
  author_url: ''
  date: '2014-01-03 22:21:48 +0100'
  date_gmt: '2014-01-03 21:21:48 +0100'
  content: "Almost 7 year later and works great!\r\n\r\nThanks a lot! :)"
---
<p>Today i decided to experiment with <a href="http:&#47;&#47;msdn2.microsoft.com&#47;en-us&#47;library&#47;system.xml.xmlwriter.aspx">XmlWriter<&#47;a>. The first i wanted to do was set the Encoding to UTF-8.:<&#47;p></p>
<p>[code lang="csharp"]StringBuilder stringBuilder = new StringBuilder();<br />
XmlWriter xmlWriter = XmlWriter.Create(stringBuilder);<br />
xmlWriter.Settings.Encoding = Encoding.UTF8;[&#47;code]</p>
<p>When i ran this code i recieved the following exception: XmlException was unhandled: The 'XmlWriterSettings.Encoding' property is read only and cannot be set. The documentation for the <a href="http:&#47;&#47;msdn2.microsoft.com&#47;en-us&#47;library&#47;system.xml.xmlwriter.settings.aspx">Settings<&#47;a> property clearly says:<&#47;p></p>
<blockquote>
<div>
The XmlWriterSettings object returned by the Settings property cannot be modified. Any attempt to change individual settings results in an exception being thrown.<br />
<&#47;div><br />
<&#47;blockquote></p>
<p>So i wrote the following:<&#47;p></p>
<p>[code lang="csharp"]StringBuilder stringBuilder = new StringBuilder();<br />
XmlWriterSettings xmlWriterSettings = new XmlWriterSettings();<br />
xmlWriterSettings.Encoding = Encoding.UTF8;</p>
<p>XmlWriter xmlWriter = XmlWriter.Create(stringBuilder, xmlWriterSettings);<br />
xmlWriter.WriteStartDocument();<br />
xmlWriter.WriteStartElement("root", "http:&#47;&#47;www.timvw.be&#47;ns");<br />
xmlWriter.WriteEndElement();<br />
xmlWriter.WriteEndDocument();<br />
xmlWriter.Flush();<br />
xmlWriter.Close();</p>
<p>string xmlString = stringBuilder.ToString();[&#47;code]</p>
<p>As you can see: <b><?xml version="1.0" encoding="utf-16"?><root xmlns="http:&#47;&#47;www.timvw.be&#47;ns" &#47;><&#47;b> is still not what i want. Apparently is the Encoding property ignored if the XmlWriter is not using a Stream. So here is my next attempt:<&#47;p></p>
<p>[code lang="csharp"]MemoryStream memoryStream = new MemoryStream();<br />
&#47;&#47; initialize xmlWriterSettings as above...</p>
<p>XmlWriter xmlWriter = XmlWriter.Create(memoryStream, xmlWriterSettings);<br />
&#47;&#47; call the same operations on the xmlWriter as above...</p>
<p>string xmlString = Encoding.UTF8.GetString(memoryStream.ToArray());[&#47;code]</p>
<p>Ok, i'm getting close: <b>?<?xml version="1.0" encoding="utf-8"?><root xmlns="http:&#47;&#47;www.timvw.be&#47;ns" &#47;><&#47;b>. Luckily enough i knew that the ? (byte with value 239) at the beginning is the <a href="http:&#47;&#47;en.wikipedia.org&#47;wiki&#47;Byte_Order_Mark">BOM<&#47;a>. In order to get rid of that byte i had to create my own instance of <a href="http:&#47;&#47;msdn2.microsoft.com&#47;en-us&#47;library&#47;system.text.utf8encoding.aspx">UTF8Encoding<&#47;a>. Finally, i can present some working code:<&#47;p><br />
[code lang="csharp"]MemoryStream memoryStream = new MemoryStream();<br />
XmlWriterSettings xmlWriterSettings = new XmlWriterSettings();<br />
xmlWriterSettings.Encoding = new UTF8Encoding(false);<br />
xmlWriterSettings.ConformanceLevel = ConformanceLevel.Document;<br />
xmlWriterSettings.Indent = true;</p>
<p>XmlWriter xmlWriter = XmlWriter.Create(memoryStream, xmlWriterSettings);<br />
xmlWriter.WriteStartDocument();<br />
xmlWriter.WriteStartElement("root", "http:&#47;&#47;www.timvw.be&#47;ns");<br />
xmlWriter.WriteEndElement();<br />
xmlWriter.WriteEndDocument();<br />
xmlWriter.Flush();<br />
xmlWriter.Close();</p>
<p>string xmlString = Encoding.UTF8.GetString(memoryStream.ToArray());[&#47;code]</p>
