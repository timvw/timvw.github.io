<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>WIF: Change STS per request - Tim Van Wassenhove</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="WIF: Change STS per request">
<meta itemprop="description" content="Here is some code that will redirect unauthenticated users to their respective STS (Eg: A user visiting ~/CompanyA/Default.aspx will be asked to authenticate at the STS linked to CompanyA.
Notice that in the enterprise you typically have multiple applications that require this kind of behavior, so you would solve this by establishing trust between your app(s) and your STS &#43; establish trust between your STS and the client STSes.)
public class Global : HttpApplication { protected void wSFederationAuthenticationModule_RedirectingToIdentityProvider(object sender, RedirectingToIdentityProviderEventArgs e) { e.">
<meta itemprop="datePublished" content="2010-09-05T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-01-04T14:49:35+01:00" />
<meta itemprop="wordCount" content="205">



<meta itemprop="keywords" content="sts,wif," />
<meta property="og:title" content="WIF: Change STS per request" />
<meta property="og:description" content="Here is some code that will redirect unauthenticated users to their respective STS (Eg: A user visiting ~/CompanyA/Default.aspx will be asked to authenticate at the STS linked to CompanyA.
Notice that in the enterprise you typically have multiple applications that require this kind of behavior, so you would solve this by establishing trust between your app(s) and your STS &#43; establish trust between your STS and the client STSes.)
public class Global : HttpApplication { protected void wSFederationAuthenticationModule_RedirectingToIdentityProvider(object sender, RedirectingToIdentityProviderEventArgs e) { e." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://timvw.be/post/2010-09-05-wif-change-sts-per-request/" />
<meta property="article:published_time" content="2010-09-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-04T14:49:35+01:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="WIF: Change STS per request"/>
<meta name="twitter:description" content="Here is some code that will redirect unauthenticated users to their respective STS (Eg: A user visiting ~/CompanyA/Default.aspx will be asked to authenticate at the STS linked to CompanyA.
Notice that in the enterprise you typically have multiple applications that require this kind of behavior, so you would solve this by establishing trust between your app(s) and your STS &#43; establish trust between your STS and the client STSes.)
public class Global : HttpApplication { protected void wSFederationAuthenticationModule_RedirectingToIdentityProvider(object sender, RedirectingToIdentityProviderEventArgs e) { e."/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://timvw.be/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://timvw.be/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://timvw.be/">Tim Van Wassenhove</a></h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"><li><a href="https://twitter.com/timvw" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://github.com/timvw" title="Github"><i data-feather="github"></i></a></li><li><a href="https://www.linkedin.com/in/timvanwassenhove" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="https://timvw.be/feed.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav></div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/post">All posts</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">05</span>
							<span class="rest">Sep 2010</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">WIF: Change STS per request</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>Here is some code that will redirect unauthenticated users to their respective STS (Eg: A user visiting ~/CompanyA/Default.aspx will be asked to authenticate at the STS linked to CompanyA.</p>
<p>Notice that in the enterprise you typically have multiple applications that require this kind of behavior, so you would solve this by establishing trust between your app(s) and your STS + establish trust between your STS and the client STSes.)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Global</span> : HttpApplication
{
	<span style="color:#000;font-weight:bold">protected</span> <span style="color:#000;font-weight:bold">void</span> wSFederationAuthenticationModule_RedirectingToIdentityProvider(<span style="color:#458;font-weight:bold">object</span> sender, RedirectingToIdentityProviderEventArgs e)
	{
		e.Cancel = <span style="color:#000;font-weight:bold">true</span>;
		RedirectToCompanySts();
	}

	<span style="color:#000;font-weight:bold">void</span> RedirectToCompanySts()
	{
		<span style="color:#458;font-weight:bold">var</span> httpContext = HttpContext.Current;
		<span style="color:#458;font-weight:bold">var</span> rawUrl = httpContext.Request.RawUrl;

		<span style="color:#458;font-weight:bold">var</span> returnUrl = rawUrl;
		<span style="color:#458;font-weight:bold">var</span> companyName = ExtractCompanyName(rawUrl);
		<span style="color:#458;font-weight:bold">var</span> companySts = GetCompanySts(companyName);
		<span style="color:#458;font-weight:bold">var</span> realm = GetRealm(companyName);
		<span style="color:#458;font-weight:bold">var</span> redirectUrl = GetRedirectUrl(companySts, realm, returnUrl);

		httpContext.Response.Redirect(redirectUrl, <span style="color:#000;font-weight:bold">false</span>);
		httpContext.ApplicationInstance.CompleteRequest();
	}

	<span style="color:#458;font-weight:bold">string</span> ExtractCompanyName(<span style="color:#458;font-weight:bold">string</span> rawUrl)
	{
		<span style="color:#458;font-weight:bold">var</span> regex = <span style="color:#d14">@&#34;~/(.\*?)/.\*&#34;</span>;
		<span style="color:#458;font-weight:bold">var</span> relativeUrl = VirtualPathUtility.ToAppRelative(rawUrl);
		<span style="color:#458;font-weight:bold">var</span> match = Regex.Match(relativeUrl, regex);
		<span style="color:#000;font-weight:bold">return</span> match.Success ? match.Groups[<span style="color:#099">1</span>].Value : <span style="color:#d14">&#34;&#34;</span>;
	}

	<span style="color:#458;font-weight:bold">string</span> GetCompanySts(<span style="color:#458;font-weight:bold">string</span> companyName)
	{
		<span style="color:#000;font-weight:bold">if</span> (companyName == <span style="color:#d14">&#34;CompanyA&#34;</span>) <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">@&#34;http://localhost/STS2Site&#34;</span>;
		<span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">@&#34;http://localhost/STSSite&#34;</span>;
	}

	<span style="color:#458;font-weight:bold">string</span> GetRealm(<span style="color:#458;font-weight:bold">string</span> companyName)
	{
		<span style="color:#458;font-weight:bold">var</span> realm = <span style="color:#d14">@&#34;http://localhost/RPSite/&#34;</span>;
		<span style="color:#000;font-weight:bold">if</span> (!<span style="color:#458;font-weight:bold">string</span>.IsNullOrEmpty(companyName)) realm += companyName +<span style="color:#d14">&#34;/&#34;</span>;
		<span style="color:#000;font-weight:bold">return</span> realm;
	}

	<span style="color:#458;font-weight:bold">string</span> GetRedirectUrl(<span style="color:#458;font-weight:bold">string</span> companySts, <span style="color:#458;font-weight:bold">string</span> realm, <span style="color:#458;font-weight:bold">string</span> returnUrl)
	{
		<span style="color:#458;font-weight:bold">var</span> signInRequestMessage = <span style="color:#000;font-weight:bold">new</span> SignInRequestMessage(<span style="color:#000;font-weight:bold">new</span> Uri(companySts), realm)
		{
			Context = returnUrl,
			HomeRealm = <span style="color:#d14">&#34;timvw&#34;</span>
		};

		<span style="color:#000;font-weight:bold">return</span> signInRequestMessage.WriteQueryString();
	}
}
</code></pre></div>
			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="/tags/sts">sts</a></li>
							
							<li><a href="/tags/wif">wif</a></li>
							
						</ul>
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2021  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-2585435-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
