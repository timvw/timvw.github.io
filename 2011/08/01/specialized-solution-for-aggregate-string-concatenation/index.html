<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Specialized solution for aggregate string concatenation - Tim Van Wassenhove</title><meta name="viewport" content="width=device-width, initial-scale=1">
	
  <meta itemprop="name" content="Specialized solution for aggregate string concatenation">
  <meta itemprop="description" content="I have noticed that most people come up with the following solution to build a string in T-SQL:
WITH [Numbers] AS (	SELECT TOP(10) [n]	FROM [Nums] )	SELECT @message = COALESCE(@message, &#39;&#39;) &#43; &#39;&#39; &#43; CAST([n] AS nvarchar(2))	FROM [Numbers]; SELECT @message = STUFF(@message, 1, 2, &#39;&#39;); SELECT @message; Important! Microsoft has no official documentation describing this aggregate concatenation technique that is based on the assignment SELECT syntax. The behavior described here is based on observation alone. The current implementation of the ConcatOrders function doesn’t incorporate an ORDER BY clause and does not guarantee the order of concatenation. According to a blog entry by Microsoft’s Conor Cunningham, it seems that SQL Server will respect an ORDER BY clause if specified (http://blogs.msdn.com/sqltips/archive/2005/07/20/441053.aspx). Conor is a very credible source, but I should stress that besides this blog entry I haven’t found any official documentation describing how a multi-row assignment SELECT should behave—with or without an ORDER BY clause.">
  <meta itemprop="datePublished" content="2011-08-01T00:00:00+00:00">
  <meta itemprop="dateModified" content="2021-01-04T22:47:36+01:00">
  <meta itemprop="wordCount" content="218">
  <meta itemprop="keywords" content="T-Sql"><meta property="og:url" content="https://timvw.be/2011/08/01/specialized-solution-for-aggregate-string-concatenation/">
  <meta property="og:site_name" content="Tim Van Wassenhove">
  <meta property="og:title" content="Specialized solution for aggregate string concatenation">
  <meta property="og:description" content="I have noticed that most people come up with the following solution to build a string in T-SQL:
WITH [Numbers] AS (	SELECT TOP(10) [n]	FROM [Nums] )	SELECT @message = COALESCE(@message, &#39;&#39;) &#43; &#39;&#39; &#43; CAST([n] AS nvarchar(2))	FROM [Numbers]; SELECT @message = STUFF(@message, 1, 2, &#39;&#39;); SELECT @message; Important! Microsoft has no official documentation describing this aggregate concatenation technique that is based on the assignment SELECT syntax. The behavior described here is based on observation alone. The current implementation of the ConcatOrders function doesn’t incorporate an ORDER BY clause and does not guarantee the order of concatenation. According to a blog entry by Microsoft’s Conor Cunningham, it seems that SQL Server will respect an ORDER BY clause if specified (http://blogs.msdn.com/sqltips/archive/2005/07/20/441053.aspx). Conor is a very credible source, but I should stress that besides this blog entry I haven’t found any official documentation describing how a multi-row assignment SELECT should behave—with or without an ORDER BY clause.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2011-08-01T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-01-04T22:47:36+01:00">
    <meta property="article:tag" content="T-Sql">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Specialized solution for aggregate string concatenation">
  <meta name="twitter:description" content="I have noticed that most people come up with the following solution to build a string in T-SQL:
WITH [Numbers] AS (	SELECT TOP(10) [n]	FROM [Nums] )	SELECT @message = COALESCE(@message, &#39;&#39;) &#43; &#39;&#39; &#43; CAST([n] AS nvarchar(2))	FROM [Numbers]; SELECT @message = STUFF(@message, 1, 2, &#39;&#39;); SELECT @message; Important! Microsoft has no official documentation describing this aggregate concatenation technique that is based on the assignment SELECT syntax. The behavior described here is based on observation alone. The current implementation of the ConcatOrders function doesn’t incorporate an ORDER BY clause and does not guarantee the order of concatenation. According to a blog entry by Microsoft’s Conor Cunningham, it seems that SQL Server will respect an ORDER BY clause if specified (http://blogs.msdn.com/sqltips/archive/2005/07/20/441053.aspx). Conor is a very credible source, but I should stress that besides this blog entry I haven’t found any official documentation describing how a multi-row assignment SELECT should behave—with or without an ORDER BY clause.">
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://timvw.be/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://timvw.be/js/main.js"></script>
	<link href="https://github.com/timvw" rel="me">
    <link href="https://timvw.be/" rel="me">
    <link href="https://fosstodon.org/@timvw" rel="me">
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://timvw.be/">Tim Van Wassenhove</a></h1>
	<div class="site-description"><p>Passionate geek, interested in Technology. Proud father of two</p><nav class="nav social">
			<ul class="flat"><li><a href="https://twitter.com/timvw" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://github.com/timvw" title="Github"><i data-feather="github"></i></a></li><li><a href="https://www.linkedin.com/in/timvanwassenhove" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="https://timvw.be/feed.xml" title="RSS"><i data-feather="rss"></i></a></li><li><a rel="me" href="https://fosstodon.org/@timvw" class="masto-link" ></a></li>
			</ul>
		
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="../../../../">Home</a>
			</li>
			
			<li>
				<a href="../../../../posts">All posts</a>
			</li>
			
			<li>
				<a href="../../../../tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">01</span>
							<span class="rest">Aug 2011</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Specialized solution for aggregate string concatenation</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>I have noticed that most people come up with the following solution to build a string in T-SQL:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">WITH</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>Numbers<span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">	  
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span>TOP<span style="color:#1f2328">(</span><span style="color:#0550ae">10</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>n<span style="color:#1f2328">]</span><span style="color:#fff">	  
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>Nums<span style="color:#1f2328">]</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">)</span><span style="color:#fff">	  
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>message<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>COALESCE<span style="color:#1f2328">(</span><span style="color:#0550ae">@</span>message<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#cf222e">CAST</span><span style="color:#1f2328">([</span>n<span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span>nvarchar<span style="color:#1f2328">(</span><span style="color:#0550ae">2</span><span style="color:#1f2328">))</span><span style="color:#fff">	  
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>Numbers<span style="color:#1f2328">];</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>message<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>STUFF<span style="color:#1f2328">(</span><span style="color:#0550ae">@</span>message<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>message<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span></code></pre></div><blockquote>
<p>Important! Microsoft has no official documentation describing this aggregate concatenation
technique that is based on the assignment SELECT syntax. The behavior described here is
based on observation alone. The current implementation of the ConcatOrders function doesn’t
incorporate
an ORDER BY clause and does not guarantee the order of concatenation. According
to a blog entry by Microsoft’s Conor Cunningham, it seems that SQL Server will respect an
ORDER BY clause if specified (<a href="http://blogs.msdn.com/sqltips/archive/2005/07/20/441053.aspx)">http://blogs.msdn.com/sqltips/archive/2005/07/20/441053.aspx)</a>.
Conor is a very credible source, but I should stress that besides
this blog entry I haven’t found
any official documentation describing how a multi-row assignment
SELECT should behave—with
or without an ORDER BY clause.</p></blockquote>
<p>With the aid of FOR XML PATH (as mentionned in <a href="http://www.sql.co.il/books/insidetsql2008/">Inside Microsoft SQL Server 2008: T-SQL Programming</a> we can solve this problem using a documented approach:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#cf222e">WITH</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>Numbers<span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#fff">	  
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span>TOP<span style="color:#1f2328">(</span><span style="color:#0550ae">10</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>n<span style="color:#1f2328">]</span><span style="color:#fff">	  
</span></span></span><span style="display:flex;"><span><span style="color:#fff">	</span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>Nums<span style="color:#1f2328">]</span><span style="color:#fff"> 
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">)</span><span style="color:#fff">	  
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>message<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#cf222e">CAST</span><span style="color:#1f2328">([</span>n<span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span>nvarchar<span style="color:#1f2328">(</span><span style="color:#0550ae">2</span><span style="color:#1f2328">))</span><span style="color:#fff"> </span><span style="color:#cf222e">AS</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#6639ba">text</span><span style="color:#1f2328">()]</span><span style="color:#fff">  
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">FROM</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span>Numbers<span style="color:#1f2328">]</span><span style="color:#fff">	  
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">FOR</span><span style="color:#fff"> </span>XML<span style="color:#fff"> </span>PATH<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#1f2328">));</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>message<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>STUFF<span style="color:#1f2328">(</span><span style="color:#0550ae">@</span>message<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">SELECT</span><span style="color:#fff"> </span><span style="color:#0550ae">@</span>message<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span></code></pre></div>
			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="../../../../tags/t-sql">t-sql</a></li>
							
						</ul>
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2025  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-9DP4SV12YW"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-9DP4SV12YW');
        }
      </script><script>feather.replace()</script>
</body>
</html>
