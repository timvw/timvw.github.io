<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Brainteaser - Tim Van Wassenhove</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="Brainteaser"><meta itemprop=description content="Earlier today Chung Leong, an intelligent regular at comp.lang.php, posted a little brainteaser:
The two functions in the example below behave differently. The difference is easy to spot, of ocurse. The challenge is correctly explaining why this is so. Why does the second function seemingly corrupt the cloned copy of an object?
function BritneySpear(&$obj) { $attr =& $obj->attributes; $clone = /* clone */ $obj; $obj->attributes[‘Length’] = 0; $obj->data = “”; return $clone; } $data = “This is a test”; $obj1->attributes = array(‘Length’ => strlen($data)); $obj1->data = $data; $clone1 = Bobcat($obj1); print_r($clone1); $obj2->attributes = array(‘Length’ => strlen($data)); $obj2->data = $data; $clone2 = BritneySpear($obj2); print_r($clone2); ?"><meta itemprop=datePublished content="2006-01-14T00:00:00+00:00"><meta itemprop=dateModified content="2021-01-04T22:47:36+01:00"><meta itemprop=wordCount content="227"><meta itemprop=keywords content="PHP,"><meta property="og:title" content="Brainteaser"><meta property="og:description" content="Earlier today Chung Leong, an intelligent regular at comp.lang.php, posted a little brainteaser:
The two functions in the example below behave differently. The difference is easy to spot, of ocurse. The challenge is correctly explaining why this is so. Why does the second function seemingly corrupt the cloned copy of an object?
function BritneySpear(&$obj) { $attr =& $obj->attributes; $clone = /* clone */ $obj; $obj->attributes[‘Length’] = 0; $obj->data = “”; return $clone; } $data = “This is a test”; $obj1->attributes = array(‘Length’ => strlen($data)); $obj1->data = $data; $clone1 = Bobcat($obj1); print_r($clone1); $obj2->attributes = array(‘Length’ => strlen($data)); $obj2->data = $data; $clone2 = BritneySpear($obj2); print_r($clone2); ?"><meta property="og:type" content="article"><meta property="og:url" content="https://timvw.be/2006/01/14/brainteaser/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2006-01-14T00:00:00+00:00"><meta property="article:modified_time" content="2021-01-04T22:47:36+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Brainteaser"><meta name=twitter:description content="Earlier today Chung Leong, an intelligent regular at comp.lang.php, posted a little brainteaser:
The two functions in the example below behave differently. The difference is easy to spot, of ocurse. The challenge is correctly explaining why this is so. Why does the second function seemingly corrupt the cloned copy of an object?
function BritneySpear(&$obj) { $attr =& $obj->attributes; $clone = /* clone */ $obj; $obj->attributes[‘Length’] = 0; $obj->data = “”; return $clone; } $data = “This is a test”; $obj1->attributes = array(‘Length’ => strlen($data)); $obj1->data = $data; $clone1 = Bobcat($obj1); print_r($clone1); $obj2->attributes = array(‘Length’ => strlen($data)); $obj2->data = $data; $clone2 = BritneySpear($obj2); print_r($clone2); ?"><link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel=stylesheet type=text/css><link rel=stylesheet type=text/css media=screen href=https://timvw.be/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://timvw.be/css/main.css><link id=dark-scheme rel=stylesheet type=text/css href=https://timvw.be/css/dark.css><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<script src=https://timvw.be/js/main.js></script></head><body><div class="container wrapper"><div class=header><h1 class=site-title><a href=https://timvw.be/>Tim Van Wassenhove</a></h1><div class=site-description><p>Passionate geek, interested in Technology. Proud father of two</p><nav class="nav social"><ul class=flat><li><a href=https://fosstodon.org/@timvw title=Mastodon><i data-feather=mastodon></i></a></li><li><a href=https://twitter.com/timvw title=Twitter><i data-feather=twitter></i></a></li><li><a href=https://github.com/timvw title=Github><i data-feather=github></i></a></li><li><a href=https://www.linkedin.com/in/timvanwassenhove title=Linkedin><i data-feather=linkedin></i></a></li><li><a href=https://timvw.be/feed.xml title=RSS><i data-feather=rss></i></a></li></ul></nav></div><nav class=nav><ul class=flat><li><a href=../../../../>Home</a></li><li><a href=../../../../posts>All posts</a></li><li><a href=../../../../tags>Tags</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>14</span>
<span class=rest>Jan 2006</span></div></div><div class=matter><h1 class=title>Brainteaser</h1></div></div><div class=markdown><p>Earlier today Chung Leong, an intelligent regular at <a href=news://comp.lang.php>comp.lang.php</a>, posted a little brainteaser:</p><blockquote><p>The two functions in the example below behave differently. The difference is easy to spot, of ocurse. The challenge is correctly explaining why this is so. Why does the second function seemingly corrupt the cloned copy of an object?</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#000;font-weight:700>function</span> <span style=color:#900;font-weight:700>BritneySpear</span>(<span style=color:#000;font-weight:700>&amp;</span><span style=color:teal>$obj</span>) {
</span></span><span style=display:flex><span><span style=color:teal>$attr</span> <span style=color:#000;font-weight:700>=&amp;</span> <span style=color:teal>$obj</span><span style=color:#000;font-weight:700>-&gt;</span><span style=color:teal>attributes</span>;
</span></span><span style=display:flex><span><span style=color:teal>$clone</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#998;font-style:italic>/* clone */</span> <span style=color:teal>$obj</span>;
</span></span><span style=display:flex><span><span style=color:teal>$obj</span><span style=color:#000;font-weight:700>-&gt;</span><span style=color:teal>attributes</span>[‘Length’] <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span>;
</span></span><span style=display:flex><span><span style=color:teal>$obj</span><span style=color:#000;font-weight:700>-&gt;</span><span style=color:teal>data</span> <span style=color:#000;font-weight:700>=</span> “”;
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>return</span> <span style=color:teal>$clone</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:teal>$data</span> <span style=color:#000;font-weight:700>=</span> “This is a test”;
</span></span><span style=display:flex><span><span style=color:teal>$obj1</span><span style=color:#000;font-weight:700>-&gt;</span><span style=color:teal>attributes</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>array</span>(‘Length’ <span style=color:#000;font-weight:700>=&gt;</span> strlen(<span style=color:teal>$data</span>));
</span></span><span style=display:flex><span><span style=color:teal>$obj1</span><span style=color:#000;font-weight:700>-&gt;</span><span style=color:teal>data</span> <span style=color:#000;font-weight:700>=</span> <span style=color:teal>$data</span>;
</span></span><span style=display:flex><span><span style=color:teal>$clone1</span> <span style=color:#000;font-weight:700>=</span> Bobcat(<span style=color:teal>$obj1</span>);
</span></span><span style=display:flex><span>print_r(<span style=color:teal>$clone1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:teal>$obj2</span><span style=color:#000;font-weight:700>-&gt;</span><span style=color:teal>attributes</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>array</span>(‘Length’ <span style=color:#000;font-weight:700>=&gt;</span> strlen(<span style=color:teal>$data</span>));
</span></span><span style=display:flex><span><span style=color:teal>$obj2</span><span style=color:#000;font-weight:700>-&gt;</span><span style=color:teal>data</span> <span style=color:#000;font-weight:700>=</span> <span style=color:teal>$data</span>;
</span></span><span style=display:flex><span><span style=color:teal>$clone2</span> <span style=color:#000;font-weight:700>=</span> BritneySpear(<span style=color:teal>$obj2</span>);
</span></span><span style=display:flex><span>print_r(<span style=color:teal>$clone2</span>);
</span></span><span style=display:flex><span><span style=color:#999;font-weight:700;font-style:italic>?&gt;</span><span style=color:#a61717;background-color:#e3d2d2>
</span></span></span></code></pre></div><blockquote><p>Result:</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#000;font-weight:700>stdClass</span> Object
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    [attributes] <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#000;font-weight:700>Array</span>
</span></span><span style=display:flex><span>        (
</span></span><span style=display:flex><span>            [Length] <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#099>14</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [data] <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#000;font-weight:700>This</span> is a test
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>stdClass</span> Object
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    [attributes] <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#000;font-weight:700>Array</span>
</span></span><span style=display:flex><span>        (
</span></span><span style=display:flex><span>            [Length] <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#099>0</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [data] <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#000;font-weight:700>This</span> is a test
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>It took me fifteen minutes to figure out the source of this mysterious behaviour, but it took me a couple of hours to come up with the following explanation: After $attr =& $obj->attributes in the BritneySpear function the container that holds this variables has is_ref=1. Any properties that are references to other variables, will remain references when $obj is copied into $clone as explained in <a href=http://php.belnet.be/manual/en/language.oop5.cloning.php>Object cloning</a>.</p><p>If you want to know more about references i can advise you to read <a href=http://derickrethans.nl/files/phparch-php-variables-article.pdf>PHP References</a> by <a href=http://derickrethans.nl>Derick Rethans</a>.</p></div><div class=tags><ul class=flat><li><a href=../../../../tags/php>PHP</a></li></ul></div></div></div><div class="footer wrapper"><nav class=nav><div>2022 <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div></nav></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-9DP4SV12YW"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9DP4SV12YW",{anonymize_ip:!1})}</script><script>feather.replace()</script></body></html>