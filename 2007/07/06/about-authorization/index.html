<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>About Authorization - Tim Van Wassenhove</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta itemprop="name" content="About Authorization">
<meta itemprop="description" content="Yesterday i visited an evening session about authentication and authorization at Compuware (Yes, i&rsquo;ve got interesting collegues that are willing to share their knowledige). Anyway, i left the meeting with a couple of questions
How does System.Security.Principal.PrincipalPolicy work under Mono?
Well, NoPrincipal and UnauthenticatedPrincipal behave exactly the same way as they do in the Microsoft implementation. For the WindowsPrincipal the unix groups are used to determine the result of IsInRole. eg">
<meta itemprop="datePublished" content="2007-07-06T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-03-15T11:37:36+01:00" />
<meta itemprop="wordCount" content="376">



<meta itemprop="keywords" content="CSharp," />
<meta property="og:title" content="About Authorization" />
<meta property="og:description" content="Yesterday i visited an evening session about authentication and authorization at Compuware (Yes, i&rsquo;ve got interesting collegues that are willing to share their knowledige). Anyway, i left the meeting with a couple of questions
How does System.Security.Principal.PrincipalPolicy work under Mono?
Well, NoPrincipal and UnauthenticatedPrincipal behave exactly the same way as they do in the Microsoft implementation. For the WindowsPrincipal the unix groups are used to determine the result of IsInRole. eg" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://timvw.be/2007/07/06/about-authorization/" />
<meta property="article:published_time" content="2007-07-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-03-15T11:37:36+01:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="About Authorization"/>
<meta name="twitter:description" content="Yesterday i visited an evening session about authentication and authorization at Compuware (Yes, i&rsquo;ve got interesting collegues that are willing to share their knowledige). Anyway, i left the meeting with a couple of questions
How does System.Security.Principal.PrincipalPolicy work under Mono?
Well, NoPrincipal and UnauthenticatedPrincipal behave exactly the same way as they do in the Microsoft implementation. For the WindowsPrincipal the unix groups are used to determine the result of IsInRole. eg"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://timvw.be/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://timvw.be/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://timvw.be/">Tim Van Wassenhove</a></h1>
	<div class="site-description"><p>Passionate geek, interested in Technology. Proud father of two</p><nav class="nav social">
			<ul class="flat"><li><a href="https://twitter.com/timvw" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://github.com/timvw" title="Github"><i data-feather="github"></i></a></li><li><a href="https://www.linkedin.com/in/timvanwassenhove" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="https://timvw.be/feed.xml" title="RSS"><i data-feather="rss"></i></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="../../../../">Home</a>
			</li>
			
			<li>
				<a href="../../../../posts">All posts</a>
			</li>
			
			<li>
				<a href="../../../../tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">06</span>
							<span class="rest">Jul 2007</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">About Authorization</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>Yesterday i visited an evening session about authentication and authorization at <a href="http://www.compuware.be">Compuware</a> (Yes, i&rsquo;ve got interesting collegues that are willing to share their knowledige). Anyway, i left the meeting with a couple of questions</p>
<p><strong>How does System.Security.Principal.PrincipalPolicy work under <a href="http://www.mono-project.com/Main_Page">Mono</a>?</strong></p>
<p>Well, NoPrincipal and UnauthenticatedPrincipal behave exactly the same way as they do in the Microsoft implementation. For the WindowsPrincipal the unix groups are used to determine the result of IsInRole. eg</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#998;font-style:italic">//lists the groups the user timvw is part of:
</span><span style="color:#998;font-style:italic">//timvw@debian:~$ groups
</span><span style="color:#998;font-style:italic">//timvw dialout cdrom floppy audio video plugdev
</span><span style="color:#998;font-style:italic"></span>
AppDomain.CurrentDomain.SetPrincipalPolicy(PrincipalPolicy.WindowsPrincipal);
IPrincipal principal = Thread.CurrentPrincipal;

<span style="color:#458;font-weight:bold">string</span>[] roles = <span style="color:#000;font-weight:bold">new</span> <span style="color:#458;font-weight:bold">string</span>[] { <span style="color:#d14">&#34;floppy&#34;</span>, <span style="color:#d14">&#34;wheel&#34;</span> };
<span style="color:#000;font-weight:bold">foreach</span>(<span style="color:#458;font-weight:bold">string</span> role <span style="color:#000;font-weight:bold">in</span> roles)
{
	Console.WriteLine(<span style="color:#d14">&#34;{0} is in the {1} role: {2}.&#34;</span>, principal.Identity.Name, role, principal.IsInRole(role));
}

<span style="color:#998;font-style:italic">// the output:
</span><span style="color:#998;font-style:italic">//timvw@debian:~$ ./Main.exe
</span><span style="color:#998;font-style:italic">//timvw is in the floppy role: True.
</span><span style="color:#998;font-style:italic">//timvw is in the wheel role: False.
</span></code></pre></div><p><strong>How are instances of IPrincipal propgated into other threads?</strong></p>
<p>A bit of research learned me that BeginInvoke and Thread.Start copy the Thread.CurrentPrincipal into the new thread and that ThreadPool.QueueUserWorkItem and System.Threading.Timer don&rsquo;t copy the Thread.CurrentPrincipal.</p>
<p><strong>How can i use the <a href="http://blogs.msdn.com/azman/">Authorization Manager</a> without Windows Identity?</strong></p>
<p>A possible solution would be the following</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">string</span> GetSid()
{
	<span style="color:#998;font-style:italic">// modify this so that it contains an application and user id
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;S-1-9-1-1&#34;</span>;
}

<span style="color:#998;font-style:italic">// By passing in 1 as the second parameter, no verification of the SID against the AD is performed
</span><span style="color:#998;font-style:italic"></span>IAzClientContext cctx = app.InitializeClientContextFromStringSid(GetSid(), <span style="color:#099">1</span>, <span style="color:#000;font-weight:bold">null</span>);

<span style="color:#998;font-style:italic">// Because the MMC does not allow you to add custom SIDs you&#39;ll have to edit to add these manually (eg: by using the API)
</span><span style="color:#998;font-style:italic"></span>IAzApplicationGroup <span style="color:#000;font-weight:bold">group</span> = app.OpenApplicationGroup(<span style="color:#d14">&#34;DemoApplicationUsers&#34;</span>, <span style="color:#000;font-weight:bold">null</span>);
<span style="color:#000;font-weight:bold">group</span>.AddMember(GetSid(), <span style="color:#000;font-weight:bold">null</span>);
<span style="color:#000;font-weight:bold">group</span>.Submit(<span style="color:#099">0</span>, <span style="color:#000;font-weight:bold">null</span>);

<span style="color:#998;font-style:italic">// And now you can verify is the custom SID has access to a given operation:
</span><span style="color:#998;font-style:italic"></span>Console.WriteLine(HasAccess(cctx, <span style="color:#000;font-weight:bold">null</span>, <span style="color:#000;font-weight:bold">new</span> <span style="color:#458;font-weight:bold">int</span>[] { <span style="color:#099">1</span> }));

<span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">bool</span> HasAccess(IAzClientContext context, <span style="color:#458;font-weight:bold">string</span>[] scopeNames, <span style="color:#458;font-weight:bold">int</span>[] operationIds)
{
	<span style="color:#458;font-weight:bold">string</span> subject = <span style="color:#d14">&#34;audit&#34;</span>;

	<span style="color:#458;font-weight:bold">object</span> scopes;
	<span style="color:#000;font-weight:bold">if</span> (scopeNames == <span style="color:#000;font-weight:bold">null</span> || scopeNames.Length == <span style="color:#099">0</span>)
	{
		scopes = <span style="color:#000;font-weight:bold">new</span> <span style="color:#458;font-weight:bold">object</span>[] { <span style="color:#d14">&#34;&#34;</span> };
	}
	<span style="color:#000;font-weight:bold">else</span>
	{
		scopes = Array.ConvertAll&lt;<span style="color:#458;font-weight:bold">string</span>, <span style="color:#458;font-weight:bold">object</span>&gt;(scopeNames, <span style="color:#000;font-weight:bold">delegate</span>(<span style="color:#458;font-weight:bold">string</span> scopeName) { <span style="color:#000;font-weight:bold">return</span> scopeName; });
	}

	<span style="color:#458;font-weight:bold">object</span>[] operations = Array.ConvertAll&lt;<span style="color:#458;font-weight:bold">int</span>, <span style="color:#458;font-weight:bold">object</span>&gt;(operationIds, <span style="color:#000;font-weight:bold">delegate</span>(<span style="color:#458;font-weight:bold">int</span> operationId) { <span style="color:#000;font-weight:bold">return</span> operationId; });
	<span style="color:#458;font-weight:bold">object</span>[] results = (<span style="color:#458;font-weight:bold">object</span>[])context.AccessCheck(subject, scopes, operations, <span style="color:#000;font-weight:bold">null</span>, <span style="color:#000;font-weight:bold">null</span>, <span style="color:#000;font-weight:bold">null</span>, <span style="color:#000;font-weight:bold">null</span>, <span style="color:#000;font-weight:bold">null</span>);
	<span style="color:#000;font-weight:bold">foreach</span> (<span style="color:#458;font-weight:bold">object</span> result <span style="color:#000;font-weight:bold">in</span> results)
	{
		<span style="color:#000;font-weight:bold">if</span> ((<span style="color:#458;font-weight:bold">int</span>)result != <span style="color:#099">0</span>)
		{
			<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">false</span>;
		}
	}

	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">true</span>;
}
</code></pre></div>
			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="../../../../tags/csharp">CSharp</a></li>
							
						</ul>
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2021  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-2585435-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script>feather.replace()</script>
</body>
</html>
