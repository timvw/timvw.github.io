<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>About Authorization - Tim Van Wassenhove</title><meta name="viewport" content="width=device-width, initial-scale=1">
	
  <meta itemprop="name" content="About Authorization">
  <meta itemprop="description" content="Yesterday i visited an evening session about authentication and authorization at Compuware (Yes, i’ve got interesting collegues that are willing to share their knowledige). Anyway, i left the meeting with a couple of questions
How does System.Security.Principal.PrincipalPolicy work under Mono?
Well, NoPrincipal and UnauthenticatedPrincipal behave exactly the same way as they do in the Microsoft implementation. For the WindowsPrincipal the unix groups are used to determine the result of IsInRole. eg
//lists the groups the user timvw is part of: //timvw@debian:~$ groups //timvw dialout cdrom floppy audio video plugdev AppDomain.CurrentDomain.SetPrincipalPolicy(PrincipalPolicy.WindowsPrincipal); IPrincipal principal = Thread.CurrentPrincipal; string[] roles = new string[] { &#34;floppy&#34;, &#34;wheel&#34; }; foreach(string role in roles) { Console.WriteLine(&#34;{0} is in the {1} role: {2}.&#34;, principal.Identity.Name, role, principal.IsInRole(role)); } // the output: //timvw@debian:~$ ./Main.exe //timvw is in the floppy role: True. //timvw is in the wheel role: False. How are instances of IPrincipal propgated into other threads?">
  <meta itemprop="datePublished" content="2007-07-06T00:00:00+00:00">
  <meta itemprop="dateModified" content="2021-01-04T22:47:36+01:00">
  <meta itemprop="wordCount" content="376">
  <meta itemprop="keywords" content="CSharp"><meta property="og:url" content="https://timvw.be/2007/07/06/about-authorization/">
  <meta property="og:site_name" content="Tim Van Wassenhove">
  <meta property="og:title" content="About Authorization">
  <meta property="og:description" content="Yesterday i visited an evening session about authentication and authorization at Compuware (Yes, i’ve got interesting collegues that are willing to share their knowledige). Anyway, i left the meeting with a couple of questions
How does System.Security.Principal.PrincipalPolicy work under Mono?
Well, NoPrincipal and UnauthenticatedPrincipal behave exactly the same way as they do in the Microsoft implementation. For the WindowsPrincipal the unix groups are used to determine the result of IsInRole. eg
//lists the groups the user timvw is part of: //timvw@debian:~$ groups //timvw dialout cdrom floppy audio video plugdev AppDomain.CurrentDomain.SetPrincipalPolicy(PrincipalPolicy.WindowsPrincipal); IPrincipal principal = Thread.CurrentPrincipal; string[] roles = new string[] { &#34;floppy&#34;, &#34;wheel&#34; }; foreach(string role in roles) { Console.WriteLine(&#34;{0} is in the {1} role: {2}.&#34;, principal.Identity.Name, role, principal.IsInRole(role)); } // the output: //timvw@debian:~$ ./Main.exe //timvw is in the floppy role: True. //timvw is in the wheel role: False. How are instances of IPrincipal propgated into other threads?">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2007-07-06T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-01-04T22:47:36+01:00">
    <meta property="article:tag" content="CSharp">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="About Authorization">
  <meta name="twitter:description" content="Yesterday i visited an evening session about authentication and authorization at Compuware (Yes, i’ve got interesting collegues that are willing to share their knowledige). Anyway, i left the meeting with a couple of questions
How does System.Security.Principal.PrincipalPolicy work under Mono?
Well, NoPrincipal and UnauthenticatedPrincipal behave exactly the same way as they do in the Microsoft implementation. For the WindowsPrincipal the unix groups are used to determine the result of IsInRole. eg
//lists the groups the user timvw is part of: //timvw@debian:~$ groups //timvw dialout cdrom floppy audio video plugdev AppDomain.CurrentDomain.SetPrincipalPolicy(PrincipalPolicy.WindowsPrincipal); IPrincipal principal = Thread.CurrentPrincipal; string[] roles = new string[] { &#34;floppy&#34;, &#34;wheel&#34; }; foreach(string role in roles) { Console.WriteLine(&#34;{0} is in the {1} role: {2}.&#34;, principal.Identity.Name, role, principal.IsInRole(role)); } // the output: //timvw@debian:~$ ./Main.exe //timvw is in the floppy role: True. //timvw is in the wheel role: False. How are instances of IPrincipal propgated into other threads?">
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://timvw.be/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://timvw.be/js/main.js"></script>
	<link href="https://github.com/timvw" rel="me">
    <link href="https://timvw.be/" rel="me">
    <link href="https://fosstodon.org/@timvw" rel="me">
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://timvw.be/">Tim Van Wassenhove</a></h1>
	<div class="site-description"><p>Passionate geek, interested in Technology. Proud father of two</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/timvw" title="Github"><i data-feather="github"></i></a></li><li><a href="https://www.linkedin.com/in/timvanwassenhove" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="https://timvw.be/feed.xml" title="RSS"><i data-feather="rss"></i></a></li><li><a rel="me" href="https://fosstodon.org/@timvw" class="masto-link" ></a></li>
			</ul>
		
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="../../../../">Home</a>
			</li>
			
			<li>
				<a href="../../../../posts">All posts</a>
			</li>
			
			<li>
				<a href="../../../../tags">Tags</a>
			</li>
			
			<li>
				<a href="../../../../contact/">Contact</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">06</span>
							<span class="rest">Jul 2007</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">About Authorization</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>Yesterday i visited an evening session about authentication and authorization at <a href="http://www.compuware.be">Compuware</a> (Yes, i&rsquo;ve got interesting collegues that are willing to share their knowledige). Anyway, i left the meeting with a couple of questions</p>
<p><strong>How does System.Security.Principal.PrincipalPolicy work under <a href="http://www.mono-project.com/Main_Page">Mono</a>?</strong></p>
<p>Well, NoPrincipal and UnauthenticatedPrincipal behave exactly the same way as they do in the Microsoft implementation. For the WindowsPrincipal the unix groups are used to determine the result of IsInRole. eg</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#57606a">//lists the groups the user timvw is part of:</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//timvw@debian:~$ groups</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//timvw dialout cdrom floppy audio video plugdev</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>AppDomain<span style="color:#1f2328">.</span>CurrentDomain<span style="color:#1f2328">.</span>SetPrincipalPolicy<span style="color:#1f2328">(</span>PrincipalPolicy<span style="color:#1f2328">.</span>WindowsPrincipal<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>IPrincipal principal <span style="color:#1f2328">=</span> Thread<span style="color:#1f2328">.</span>CurrentPrincipal<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">string</span><span style="color:#1f2328">[]</span> roles <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">[]</span> <span style="color:#1f2328">{</span> <span style="color:#0a3069">&#34;floppy&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;wheel&#34;</span> <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">foreach</span><span style="color:#1f2328">(</span><span style="color:#cf222e">string</span> role <span style="color:#cf222e">in</span> roles<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	Console<span style="color:#1f2328">.</span>WriteLine<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;{0} is in the {1} role: {2}.&#34;</span><span style="color:#1f2328">,</span> principal<span style="color:#1f2328">.</span>Identity<span style="color:#1f2328">.</span>Name<span style="color:#1f2328">,</span> role<span style="color:#1f2328">,</span> principal<span style="color:#1f2328">.</span>IsInRole<span style="color:#1f2328">(</span>role<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// the output:</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//timvw@debian:~$ ./Main.exe</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//timvw is in the floppy role: True.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//timvw is in the wheel role: False.</span>
</span></span></code></pre></div><p><strong>How are instances of IPrincipal propgated into other threads?</strong></p>
<p>A bit of research learned me that BeginInvoke and Thread.Start copy the Thread.CurrentPrincipal into the new thread and that ThreadPool.QueueUserWorkItem and System.Threading.Timer don&rsquo;t copy the Thread.CurrentPrincipal.</p>
<p><strong>How can i use the <a href="http://blogs.msdn.com/azman/">Authorization Manager</a> without Windows Identity?</strong></p>
<p>A possible solution would be the following</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">static</span> <span style="color:#cf222e">string</span> GetSid<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">// modify this so that it contains an application and user id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#0a3069">&#34;S-1-9-1-1&#34;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// By passing in 1 as the second parameter, no verification of the SID against the AD is performed</span>
</span></span><span style="display:flex;"><span>IAzClientContext cctx <span style="color:#1f2328">=</span> app<span style="color:#1f2328">.</span>InitializeClientContextFromStringSid<span style="color:#1f2328">(</span>GetSid<span style="color:#1f2328">(),</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">null</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Because the MMC does not allow you to add custom SIDs you&#39;ll have to edit to add these manually (eg: by using the API)</span>
</span></span><span style="display:flex;"><span>IAzApplicationGroup <span style="color:#cf222e">group</span> <span style="color:#1f2328">=</span> app<span style="color:#1f2328">.</span>OpenApplicationGroup<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;DemoApplicationUsers&#34;</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">null</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">group</span><span style="color:#1f2328">.</span>AddMember<span style="color:#1f2328">(</span>GetSid<span style="color:#1f2328">(),</span> <span style="color:#cf222e">null</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">group</span><span style="color:#1f2328">.</span>Submit<span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">null</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// And now you can verify is the custom SID has access to a given operation:</span>
</span></span><span style="display:flex;"><span>Console<span style="color:#1f2328">.</span>WriteLine<span style="color:#1f2328">(</span>HasAccess<span style="color:#1f2328">(</span>cctx<span style="color:#1f2328">,</span> <span style="color:#cf222e">null</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">new</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">[]</span> <span style="color:#1f2328">{</span> <span style="color:#0550ae">1</span> <span style="color:#1f2328">}));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">static</span> <span style="color:#cf222e">bool</span> HasAccess<span style="color:#1f2328">(</span>IAzClientContext context<span style="color:#1f2328">,</span> <span style="color:#cf222e">string</span><span style="color:#1f2328">[]</span> scopeNames<span style="color:#1f2328">,</span> <span style="color:#cf222e">int</span><span style="color:#1f2328">[]</span> operationIds<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">string</span> subject <span style="color:#1f2328">=</span> <span style="color:#0a3069">&#34;audit&#34;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">object</span> scopes<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>scopeNames <span style="color:#1f2328">==</span> <span style="color:#cf222e">null</span> <span style="color:#1f2328">||</span> scopeNames<span style="color:#1f2328">.</span>Length <span style="color:#1f2328">==</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		scopes <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> <span style="color:#cf222e">object</span><span style="color:#1f2328">[]</span> <span style="color:#1f2328">{</span> <span style="color:#0a3069">&#34;&#34;</span> <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">else</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		scopes <span style="color:#1f2328">=</span> Array<span style="color:#1f2328">.</span>ConvertAll<span style="color:#1f2328">&lt;</span><span style="color:#cf222e">string</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">object</span><span style="color:#1f2328">&gt;(</span>scopeNames<span style="color:#1f2328">,</span> <span style="color:#cf222e">delegate</span><span style="color:#1f2328">(</span><span style="color:#cf222e">string</span> scopeName<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span> <span style="color:#cf222e">return</span> scopeName<span style="color:#1f2328">;</span> <span style="color:#1f2328">});</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">object</span><span style="color:#1f2328">[]</span> operations <span style="color:#1f2328">=</span> Array<span style="color:#1f2328">.</span>ConvertAll<span style="color:#1f2328">&lt;</span><span style="color:#cf222e">int</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">object</span><span style="color:#1f2328">&gt;(</span>operationIds<span style="color:#1f2328">,</span> <span style="color:#cf222e">delegate</span><span style="color:#1f2328">(</span><span style="color:#cf222e">int</span> operationId<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span> <span style="color:#cf222e">return</span> operationId<span style="color:#1f2328">;</span> <span style="color:#1f2328">});</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">object</span><span style="color:#1f2328">[]</span> results <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">object</span><span style="color:#1f2328">[])</span>context<span style="color:#1f2328">.</span>AccessCheck<span style="color:#1f2328">(</span>subject<span style="color:#1f2328">,</span> scopes<span style="color:#1f2328">,</span> operations<span style="color:#1f2328">,</span> <span style="color:#cf222e">null</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">null</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">null</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">null</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">null</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">foreach</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">object</span> result <span style="color:#cf222e">in</span> results<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">((</span><span style="color:#cf222e">int</span><span style="color:#1f2328">)</span>result <span style="color:#1f2328">!=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">return</span> <span style="color:#cf222e">false</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#cf222e">true</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div>
			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="../../../../tags/csharp">CSharp</a></li>
							
						</ul>
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2025  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-9DP4SV12YW"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-9DP4SV12YW');
        }
      </script><script>feather.replace()</script>
</body>
</html>
