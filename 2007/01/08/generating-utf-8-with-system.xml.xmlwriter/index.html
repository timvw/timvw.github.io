<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Generating UTF-8 with System.Xml.XmlWriter - Tim Van Wassenhove</title><meta name="viewport" content="width=device-width, initial-scale=1">
	
  <meta itemprop="name" content="Generating UTF-8 with System.Xml.XmlWriter">
  <meta itemprop="description" content="Today i decided to experiment with XmlWriter. The first i wanted to do was set the Encoding to UTF-8.
StringBuilder stringBuilder = new StringBuilder(); XmlWriter xmlWriter = XmlWriter.Create(stringBuilder); xmlWriter.Settings.Encoding = Encoding.UTF8; When i ran this code i recieved the following exception: XmlException was unhandled: The ‘XmlWriterSettings.Encoding’ property is read only and cannot be set. The documentation for the Settings property clearly says
The XmlWriterSettings object returned by the Settings property cannot be modified. Any attempt to change individual settings results in an exception being thrown. So i wrote the following">
  <meta itemprop="datePublished" content="2007-01-08T00:00:00+00:00">
  <meta itemprop="dateModified" content="2021-01-04T22:47:36+01:00">
  <meta itemprop="wordCount" content="265">
  <meta itemprop="keywords" content="CSharp,XML"><meta property="og:url" content="https://timvw.be/2007/01/08/generating-utf-8-with-system.xml.xmlwriter/">
  <meta property="og:site_name" content="Tim Van Wassenhove">
  <meta property="og:title" content="Generating UTF-8 with System.Xml.XmlWriter">
  <meta property="og:description" content="Today i decided to experiment with XmlWriter. The first i wanted to do was set the Encoding to UTF-8.
StringBuilder stringBuilder = new StringBuilder(); XmlWriter xmlWriter = XmlWriter.Create(stringBuilder); xmlWriter.Settings.Encoding = Encoding.UTF8; When i ran this code i recieved the following exception: XmlException was unhandled: The ‘XmlWriterSettings.Encoding’ property is read only and cannot be set. The documentation for the Settings property clearly says
The XmlWriterSettings object returned by the Settings property cannot be modified. Any attempt to change individual settings results in an exception being thrown. So i wrote the following">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2007-01-08T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-01-04T22:47:36+01:00">
    <meta property="article:tag" content="CSharp">
    <meta property="article:tag" content="XML">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Generating UTF-8 with System.Xml.XmlWriter">
  <meta name="twitter:description" content="Today i decided to experiment with XmlWriter. The first i wanted to do was set the Encoding to UTF-8.
StringBuilder stringBuilder = new StringBuilder(); XmlWriter xmlWriter = XmlWriter.Create(stringBuilder); xmlWriter.Settings.Encoding = Encoding.UTF8; When i ran this code i recieved the following exception: XmlException was unhandled: The ‘XmlWriterSettings.Encoding’ property is read only and cannot be set. The documentation for the Settings property clearly says
The XmlWriterSettings object returned by the Settings property cannot be modified. Any attempt to change individual settings results in an exception being thrown. So i wrote the following">
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://timvw.be/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://timvw.be/js/main.js"></script>
	<link href="https://github.com/timvw" rel="me">
    <link href="https://timvw.be/" rel="me">
    <link href="https://fosstodon.org/@timvw" rel="me">
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://timvw.be/">Tim Van Wassenhove</a></h1>
	<div class="site-description"><p>Passionate geek, interested in Technology. Proud father of two</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/timvw" title="Github"><i data-feather="github"></i></a></li><li><a href="https://www.linkedin.com/in/timvanwassenhove" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="https://timvw.be/feed.xml" title="RSS"><i data-feather="rss"></i></a></li><li><a rel="me" href="https://fosstodon.org/@timvw" class="masto-link" ></a></li>
			</ul>
		
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="../../../../">Home</a>
			</li>
			
			<li>
				<a href="../../../../posts">All posts</a>
			</li>
			
			<li>
				<a href="../../../../tags">Tags</a>
			</li>
			
			<li>
				<a href="../../../../contact/">Contact</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">08</span>
							<span class="rest">Jan 2007</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Generating UTF-8 with System.Xml.XmlWriter</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>Today i decided to experiment with <a href="http://msdn2.microsoft.com/en-us/library/system.xml.xmlwriter.aspx">XmlWriter</a>. The first i wanted to do was set the Encoding to UTF-8.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>StringBuilder stringBuilder <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> StringBuilder<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>XmlWriter xmlWriter <span style="color:#1f2328">=</span> XmlWriter<span style="color:#1f2328">.</span>Create<span style="color:#1f2328">(</span>stringBuilder<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>Settings<span style="color:#1f2328">.</span>Encoding <span style="color:#1f2328">=</span> Encoding<span style="color:#1f2328">.</span>UTF8<span style="color:#1f2328">;</span>
</span></span></code></pre></div><p>When i ran this code i recieved the following exception: XmlException was unhandled: The &lsquo;XmlWriterSettings.Encoding&rsquo; property is read only and cannot be set. The documentation for the <a href="http://msdn2.microsoft.com/en-us/library/system.xml.xmlwriter.settings.aspx">Settings</a> property clearly says</p>
<blockquote>
<div>
  The XmlWriterSettings object returned by the Settings property cannot be modified. Any attempt to change individual settings results in an exception being thrown.
</div></blockquote>
<p>So i wrote the following</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>StringBuilder stringBuilder <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> StringBuilder<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>XmlWriterSettings xmlWriterSettings <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> XmlWriterSettings<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>xmlWriterSettings<span style="color:#1f2328">.</span>Encoding <span style="color:#1f2328">=</span> Encoding<span style="color:#1f2328">.</span>UTF8<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>XmlWriter xmlWriter <span style="color:#1f2328">=</span> XmlWriter<span style="color:#1f2328">.</span>Create<span style="color:#1f2328">(</span>stringBuilder<span style="color:#1f2328">,</span> xmlWriterSettings<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>WriteStartDocument<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>WriteStartElement<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;root&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;http://www.timvw.be/ns&#34;</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>WriteEndElement<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>WriteEndDocument<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>Flush<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>Close<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">string</span> xmlString <span style="color:#1f2328">=</span> stringBuilder<span style="color:#1f2328">.</span>ToString<span style="color:#1f2328">();</span>
</span></span></code></pre></div><p>As you can see: <strong><?xml version="1.0" encoding="utf-16"?><root xmlns="http://www.timvw.be/ns" /></strong> is still not what i want. Apparently is the Encoding property ignored if the XmlWriter is not using a Stream. So here is my next attempt</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>MemoryStream memoryStream <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> MemoryStream<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// initialize xmlWriterSettings as above...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>XmlWriter xmlWriter <span style="color:#1f2328">=</span> XmlWriter<span style="color:#1f2328">.</span>Create<span style="color:#1f2328">(</span>memoryStream<span style="color:#1f2328">,</span> xmlWriterSettings<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// call the same operations on the xmlWriter as above...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">string</span> xmlString <span style="color:#1f2328">=</span> Encoding<span style="color:#1f2328">.</span>UTF8<span style="color:#1f2328">.</span>GetString<span style="color:#1f2328">(</span>memoryStream<span style="color:#1f2328">.</span>ToArray<span style="color:#1f2328">());</span>
</span></span></code></pre></div><p>Ok, i&rsquo;m getting close: <strong>?<?xml version="1.0" encoding="utf-8"?><root xmlns="http://www.timvw.be/ns" /></strong>. Luckily enough i knew that the ? (byte with value 239) at the beginning is the <a href="http://en.wikipedia.org/wiki/Byte_Order_Mark">BOM</a>. In order to get rid of that byte i had to create my own instance of <a href="http://msdn2.microsoft.com/en-us/library/system.text.utf8encoding.aspx">UTF8Encoding</a>. Finally, i can present some working code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>MemoryStream memoryStream <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> MemoryStream<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>XmlWriterSettings xmlWriterSettings <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> XmlWriterSettings<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>xmlWriterSettings<span style="color:#1f2328">.</span>Encoding <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> UTF8Encoding<span style="color:#1f2328">(</span><span style="color:#cf222e">false</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>xmlWriterSettings<span style="color:#1f2328">.</span>ConformanceLevel <span style="color:#1f2328">=</span> ConformanceLevel<span style="color:#1f2328">.</span>Document<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>xmlWriterSettings<span style="color:#1f2328">.</span>Indent <span style="color:#1f2328">=</span> <span style="color:#cf222e">true</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>XmlWriter xmlWriter <span style="color:#1f2328">=</span> XmlWriter<span style="color:#1f2328">.</span>Create<span style="color:#1f2328">(</span>memoryStream<span style="color:#1f2328">,</span> xmlWriterSettings<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>WriteStartDocument<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>WriteStartElement<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;root&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;http://www.timvw.be/ns&#34;</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>WriteEndElement<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>WriteEndDocument<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>Flush<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>xmlWriter<span style="color:#1f2328">.</span>Close<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">string</span> xmlString <span style="color:#1f2328">=</span> Encoding<span style="color:#1f2328">.</span>UTF8<span style="color:#1f2328">.</span>GetString<span style="color:#1f2328">(</span>memoryStream<span style="color:#1f2328">.</span>ToArray<span style="color:#1f2328">());</span>
</span></span></code></pre></div>
			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="../../../../tags/csharp">CSharp</a></li>
							
							<li><a href="../../../../tags/xml">XML</a></li>
							
						</ul>
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2025  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-9DP4SV12YW"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-9DP4SV12YW');
        }
      </script><script>feather.replace()</script>
</body>
</html>
