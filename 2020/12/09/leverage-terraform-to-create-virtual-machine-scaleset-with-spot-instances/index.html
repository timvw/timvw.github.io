<!doctype html><html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Leverage Terraform to create virtual machine scaleset with spot instances - Tim Van Wassenhove</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta itemprop=name content="Leverage Terraform to create virtual machine scaleset with spot instances">
<meta itemprop=description content="In a previous post I demonstrated how easy it has become to deploy a webapplications with an HTTPS backend on Kubernetes and Azure. Let&rsquo;s expand this cluster with a node pool that is backed by spot instances:
resource &#34;azurerm_kubernetes_cluster_node_pool&#34; &#34;spot&#34; {name = &#34;spot&#34;kubernetes_cluster_id = azurerm_kubernetes_cluster.k8s.idvm_size = &#34;standard_D2s_v4&#34;node_count = 0enable_auto_scaling = truemin_count = 0max_count = 5priority = &#34;Spot&#34;eviction_policy = &#34;Delete&#34;spot_max_price = 0.02tags = var.tags}The nodes in this pool will be tainted with kubernetes."><meta itemprop=datePublished content="2020-12-09T00:00:00+00:00">
<meta itemprop=dateModified content="2021-01-04T22:47:36+01:00">
<meta itemprop=wordCount content="149">
<meta itemprop=keywords content><meta property="og:title" content="Leverage Terraform to create virtual machine scaleset with spot instances">
<meta property="og:description" content="In a previous post I demonstrated how easy it has become to deploy a webapplications with an HTTPS backend on Kubernetes and Azure. Let&rsquo;s expand this cluster with a node pool that is backed by spot instances:
resource &#34;azurerm_kubernetes_cluster_node_pool&#34; &#34;spot&#34; {name = &#34;spot&#34;kubernetes_cluster_id = azurerm_kubernetes_cluster.k8s.idvm_size = &#34;standard_D2s_v4&#34;node_count = 0enable_auto_scaling = truemin_count = 0max_count = 5priority = &#34;Spot&#34;eviction_policy = &#34;Delete&#34;spot_max_price = 0.02tags = var.tags}The nodes in this pool will be tainted with kubernetes.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://timvw.be/2020/12/09/leverage-terraform-to-create-virtual-machine-scaleset-with-spot-instances/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-12-09T00:00:00+00:00">
<meta property="article:modified_time" content="2021-01-04T22:47:36+01:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Leverage Terraform to create virtual machine scaleset with spot instances">
<meta name=twitter:description content="In a previous post I demonstrated how easy it has become to deploy a webapplications with an HTTPS backend on Kubernetes and Azure. Let&rsquo;s expand this cluster with a node pool that is backed by spot instances:
resource &#34;azurerm_kubernetes_cluster_node_pool&#34; &#34;spot&#34; {name = &#34;spot&#34;kubernetes_cluster_id = azurerm_kubernetes_cluster.k8s.idvm_size = &#34;standard_D2s_v4&#34;node_count = 0enable_auto_scaling = truemin_count = 0max_count = 5priority = &#34;Spot&#34;eviction_policy = &#34;Delete&#34;spot_max_price = 0.02tags = var.tags}The nodes in this pool will be tainted with kubernetes.">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css>
<link rel=stylesheet type=text/css media=screen href=https://timvw.be/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=https://timvw.be/css/main.css>
<link id=dark-scheme rel=stylesheet type=text/css href=https://timvw.be/css/dark.css>
<script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<script src=https://timvw.be/js/main.js></script>
</head>
<body>
<div class="container wrapper">
<div class=header>
<h1 class=site-title><a href=https://timvw.be/>Tim Van Wassenhove</a></h1>
<div class=site-description><p>Passionate geek, interested in Technology. Proud father of two</p><nav class="nav social">
<ul class=flat><li><a href=https://twitter.com/timvw title=Twitter><i data-feather=twitter></i></a></li><li><a href=https://github.com/timvw title=Github><i data-feather=github></i></a></li><li><a href=https://www.linkedin.com/in/timvanwassenhove title=Linkedin><i data-feather=linkedin></i></a></li><li><a href=https://timvw.be/feed.xml title=RSS><i data-feather=rss></i></a></li></ul>
</nav>
</div>
<nav class=nav>
<ul class=flat>
<li>
<a href=../../../../>Home</a>
</li>
<li>
<a href=../../../../posts>All posts</a>
</li>
<li>
<a href=../../../../tags>Tags</a>
</li>
</ul>
</nav>
</div>
<div class=post>
<div class=post-header>
<div class=meta>
<div class=date>
<span class=day>09</span>
<span class=rest>Dec 2020</span>
</div>
</div>
<div class=matter>
<h1 class=title>Leverage Terraform to create virtual machine scaleset with spot instances</h1>
</div>
</div>
<div class=markdown>
<p>In a <a href=https://timvw.be/2020/02/10/terraform-azure-k8s-nginx-letsencrypt.html>previous</a> post I demonstrated how easy it has become to deploy a webapplications with an HTTPS backend on Kubernetes and Azure. Let&rsquo;s expand this cluster with a node pool that is backed by <a href=https://azure.microsoft.com/en-us/pricing/spot/>spot</a> instances:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>resource &#34;azurerm_kubernetes_cluster_node_pool&#34; &#34;spot&#34; {<span style=color:#bbb>
</span><span style=color:#bbb>    </span>name                  = &#34;spot&#34;<span style=color:#bbb>
</span><span style=color:#bbb>    </span>kubernetes_cluster_id = azurerm_kubernetes_cluster.k8s.id<span style=color:#bbb>
</span><span style=color:#bbb>    </span>vm_size         = &#34;standard_D2s_v4&#34;<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>node_count      = 0<span style=color:#bbb>
</span><span style=color:#bbb>    </span>enable_auto_scaling = true<span style=color:#bbb>
</span><span style=color:#bbb>    </span>min_count = 0<span style=color:#bbb>
</span><span style=color:#bbb>    </span>max_count = 5<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>priority = &#34;Spot&#34;<span style=color:#bbb>
</span><span style=color:#bbb>    </span>eviction_policy = &#34;Delete&#34;<span style=color:#bbb>
</span><span style=color:#bbb>    </span>spot_max_price = 0.02<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>tags       = var.tags<span style=color:#bbb>
</span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></code></pre></div><p>The nodes in this pool will be <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/>tainted</a> with kubernetes.azure.com/scalesetpriority=spot:NoSchedule.</p>
<p>For a pod to land on a node in this pool you will have to specify a toleration. Here is how you would do this in <a href=https://spark.apache.org/>Apache Spark</a>:</p>
<p>First create a pod.yml file in which you specify the toleration:</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:navy>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>annotations</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>cluster-autoscaler.kubernetes.io/safe-to-evict</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:navy>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:navy>tolerations</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:navy>key</span>:<span style=color:#bbb> </span><span style=color:#d14>&#34;kubernetes.azure.com/scalesetpriority&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>operator</span>:<span style=color:#bbb> </span><span style=color:#d14>&#34;Equal&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>value</span>:<span style=color:#bbb> </span><span style=color:#d14>&#34;spot&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:navy>effect</span>:<span style=color:#bbb> </span><span style=color:#d14>&#34;NoSchedule&#34;</span><span style=color:#bbb>
</span></code></pre></div><p>And now you can submit the app</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./bin/spark-submit <span style=color:#d14>\
</span><span style=color:#d14></span>  --master k8s://<span style=color:teal>$KUBERNETES_MASTER_API</span> <span style=color:#d14>\
</span><span style=color:#d14></span>  --deploy-mode cluster <span style=color:#d14>\
</span><span style=color:#d14></span>  --name spark-pi <span style=color:#d14>\
</span><span style=color:#d14></span>  --class org.apache.spark.examples.SparkPi <span style=color:#d14>\
</span><span style=color:#d14></span>  --conf spark.executor.instances<span style=color:#000;font-weight:700>=</span><span style=color:#099>1</span> <span style=color:#d14>\
</span><span style=color:#d14></span>  --conf spark.kubernetes.container.image<span style=color:#000;font-weight:700>=</span>timvw/spark:3.0.1-hadoop2.7 <span style=color:#d14>\
</span><span style=color:#d14></span>  --conf spark.kubernetes.driver.podTemplateFile<span style=color:#000;font-weight:700>=</span>pod.yml <span style=color:#d14>\
</span><span style=color:#d14></span>  --conf spark.kubernetes.executor.podTemplateFile<span style=color:#000;font-weight:700>=</span>pod.yml <span style=color:#d14>\
</span><span style=color:#d14></span>  --conf spark.kubernetes.node.selector.agentpool<span style=color:#000;font-weight:700>=</span>spot <span style=color:#d14>\
</span><span style=color:#d14></span>  local:///opt/spark/examples/jars/spark-examples_2.12-3.0.1.jar
</code></pre></div>
</div>
<div class=tags>
</div></div>
</div>
<div class="footer wrapper">
<nav class=nav>
<div>2022 <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div>
</nav>
</div>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-9DP4SV12YW','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
<script>feather.replace()</script>
</body>
</html>