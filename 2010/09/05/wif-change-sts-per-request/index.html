<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>WIF: Change STS per request - Tim Van Wassenhove</title><meta name="viewport" content="width=device-width, initial-scale=1">
	
  <meta itemprop="name" content="WIF: Change STS per request">
  <meta itemprop="description" content="Here is some code that will redirect unauthenticated users to their respective STS (Eg: A user visiting ~/CompanyA/Default.aspx will be asked to authenticate at the STS linked to CompanyA.
Notice that in the enterprise you typically have multiple applications that require this kind of behavior, so you would solve this by establishing trust between your app(s) and your STS &#43; establish trust between your STS and the client STSes.)
public class Global : HttpApplication { protected void wSFederationAuthenticationModule_RedirectingToIdentityProvider(object sender, RedirectingToIdentityProviderEventArgs e) { e.Cancel = true; RedirectToCompanySts(); } void RedirectToCompanySts() { var httpContext = HttpContext.Current; var rawUrl = httpContext.Request.RawUrl; var returnUrl = rawUrl; var companyName = ExtractCompanyName(rawUrl); var companySts = GetCompanySts(companyName); var realm = GetRealm(companyName); var redirectUrl = GetRedirectUrl(companySts, realm, returnUrl); httpContext.Response.Redirect(redirectUrl, false); httpContext.ApplicationInstance.CompleteRequest(); } string ExtractCompanyName(string rawUrl) { var regex = @&#34;~/(.\*?)/.\*&#34;; var relativeUrl = VirtualPathUtility.ToAppRelative(rawUrl); var match = Regex.Match(relativeUrl, regex); return match.Success ? match.Groups[1].Value : &#34;&#34;; } string GetCompanySts(string companyName) { if (companyName == &#34;CompanyA&#34;) return @&#34;http://localhost/STS2Site&#34;; return @&#34;http://localhost/STSSite&#34;; } string GetRealm(string companyName) { var realm = @&#34;http://localhost/RPSite/&#34;; if (!string.IsNullOrEmpty(companyName)) realm &#43;= companyName &#43;&#34;/&#34;; return realm; } string GetRedirectUrl(string companySts, string realm, string returnUrl) { var signInRequestMessage = new SignInRequestMessage(new Uri(companySts), realm) { Context = returnUrl, HomeRealm = &#34;timvw&#34; }; return signInRequestMessage.WriteQueryString(); } }">
  <meta itemprop="datePublished" content="2010-09-05T00:00:00+00:00">
  <meta itemprop="dateModified" content="2021-01-04T22:47:36+01:00">
  <meta itemprop="wordCount" content="205">
  <meta itemprop="keywords" content="Sts,Wif"><meta property="og:url" content="https://timvw.be/2010/09/05/wif-change-sts-per-request/">
  <meta property="og:site_name" content="Tim Van Wassenhove">
  <meta property="og:title" content="WIF: Change STS per request">
  <meta property="og:description" content="Here is some code that will redirect unauthenticated users to their respective STS (Eg: A user visiting ~/CompanyA/Default.aspx will be asked to authenticate at the STS linked to CompanyA.
Notice that in the enterprise you typically have multiple applications that require this kind of behavior, so you would solve this by establishing trust between your app(s) and your STS &#43; establish trust between your STS and the client STSes.)
public class Global : HttpApplication { protected void wSFederationAuthenticationModule_RedirectingToIdentityProvider(object sender, RedirectingToIdentityProviderEventArgs e) { e.Cancel = true; RedirectToCompanySts(); } void RedirectToCompanySts() { var httpContext = HttpContext.Current; var rawUrl = httpContext.Request.RawUrl; var returnUrl = rawUrl; var companyName = ExtractCompanyName(rawUrl); var companySts = GetCompanySts(companyName); var realm = GetRealm(companyName); var redirectUrl = GetRedirectUrl(companySts, realm, returnUrl); httpContext.Response.Redirect(redirectUrl, false); httpContext.ApplicationInstance.CompleteRequest(); } string ExtractCompanyName(string rawUrl) { var regex = @&#34;~/(.\*?)/.\*&#34;; var relativeUrl = VirtualPathUtility.ToAppRelative(rawUrl); var match = Regex.Match(relativeUrl, regex); return match.Success ? match.Groups[1].Value : &#34;&#34;; } string GetCompanySts(string companyName) { if (companyName == &#34;CompanyA&#34;) return @&#34;http://localhost/STS2Site&#34;; return @&#34;http://localhost/STSSite&#34;; } string GetRealm(string companyName) { var realm = @&#34;http://localhost/RPSite/&#34;; if (!string.IsNullOrEmpty(companyName)) realm &#43;= companyName &#43;&#34;/&#34;; return realm; } string GetRedirectUrl(string companySts, string realm, string returnUrl) { var signInRequestMessage = new SignInRequestMessage(new Uri(companySts), realm) { Context = returnUrl, HomeRealm = &#34;timvw&#34; }; return signInRequestMessage.WriteQueryString(); } }">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2010-09-05T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-01-04T22:47:36+01:00">
    <meta property="article:tag" content="Sts">
    <meta property="article:tag" content="Wif">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="WIF: Change STS per request">
  <meta name="twitter:description" content="Here is some code that will redirect unauthenticated users to their respective STS (Eg: A user visiting ~/CompanyA/Default.aspx will be asked to authenticate at the STS linked to CompanyA.
Notice that in the enterprise you typically have multiple applications that require this kind of behavior, so you would solve this by establishing trust between your app(s) and your STS &#43; establish trust between your STS and the client STSes.)
public class Global : HttpApplication { protected void wSFederationAuthenticationModule_RedirectingToIdentityProvider(object sender, RedirectingToIdentityProviderEventArgs e) { e.Cancel = true; RedirectToCompanySts(); } void RedirectToCompanySts() { var httpContext = HttpContext.Current; var rawUrl = httpContext.Request.RawUrl; var returnUrl = rawUrl; var companyName = ExtractCompanyName(rawUrl); var companySts = GetCompanySts(companyName); var realm = GetRealm(companyName); var redirectUrl = GetRedirectUrl(companySts, realm, returnUrl); httpContext.Response.Redirect(redirectUrl, false); httpContext.ApplicationInstance.CompleteRequest(); } string ExtractCompanyName(string rawUrl) { var regex = @&#34;~/(.\*?)/.\*&#34;; var relativeUrl = VirtualPathUtility.ToAppRelative(rawUrl); var match = Regex.Match(relativeUrl, regex); return match.Success ? match.Groups[1].Value : &#34;&#34;; } string GetCompanySts(string companyName) { if (companyName == &#34;CompanyA&#34;) return @&#34;http://localhost/STS2Site&#34;; return @&#34;http://localhost/STSSite&#34;; } string GetRealm(string companyName) { var realm = @&#34;http://localhost/RPSite/&#34;; if (!string.IsNullOrEmpty(companyName)) realm &#43;= companyName &#43;&#34;/&#34;; return realm; } string GetRedirectUrl(string companySts, string realm, string returnUrl) { var signInRequestMessage = new SignInRequestMessage(new Uri(companySts), realm) { Context = returnUrl, HomeRealm = &#34;timvw&#34; }; return signInRequestMessage.WriteQueryString(); } }">
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://timvw.be/css/main.css" />

        <link id="dark-scheme" rel="stylesheet" type="text/css" href="https://timvw.be/css/dark.css" />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
		<script src="https://timvw.be/js/main.js"></script>
	<link href="https://github.com/timvw" rel="me">
    <link href="https://timvw.be/" rel="me">
    <link href="https://fosstodon.org/@timvw" rel="me">
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://timvw.be/">Tim Van Wassenhove</a></h1>
	<div class="site-description"><p>Passionate geek, interested in Technology. Proud father of two</p><nav class="nav social">
			<ul class="flat"><li><a href="https://twitter.com/timvw" title="Twitter"><i data-feather="twitter"></i></a></li><li><a href="https://github.com/timvw" title="Github"><i data-feather="github"></i></a></li><li><a href="https://www.linkedin.com/in/timvanwassenhove" title="Linkedin"><i data-feather="linkedin"></i></a></li><li><a href="https://timvw.be/feed.xml" title="RSS"><i data-feather="rss"></i></a></li><li><a rel="me" href="https://fosstodon.org/@timvw" class="masto-link" ></a></li>
			</ul>
		
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="../../../../">Home</a>
			</li>
			
			<li>
				<a href="../../../../posts">All posts</a>
			</li>
			
			<li>
				<a href="../../../../tags">Tags</a>
			</li>
			
			<li>
				<a href="../../../../about/">About Me</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">05</span>
							<span class="rest">Sep 2010</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">WIF: Change STS per request</h1>
				</div>
			</div>
					
			<div class="markdown">
				<p>Here is some code that will redirect unauthenticated users to their respective STS (Eg: A user visiting ~/CompanyA/Default.aspx will be asked to authenticate at the STS linked to CompanyA.</p>
<p>Notice that in the enterprise you typically have multiple applications that require this kind of behavior, so you would solve this by establishing trust between your app(s) and your STS + establish trust between your STS and the client STSes.)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">public</span> <span style="color:#cf222e">class</span> <span style="color:#1f2328">Global</span> <span style="color:#1f2328">:</span> HttpApplication
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">protected</span> <span style="color:#cf222e">void</span> wSFederationAuthenticationModule_RedirectingToIdentityProvider<span style="color:#1f2328">(</span><span style="color:#cf222e">object</span> sender<span style="color:#1f2328">,</span> RedirectingToIdentityProviderEventArgs e<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		e<span style="color:#1f2328">.</span>Cancel <span style="color:#1f2328">=</span> <span style="color:#cf222e">true</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>		RedirectToCompanySts<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">void</span> RedirectToCompanySts<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> httpContext <span style="color:#1f2328">=</span> HttpContext<span style="color:#1f2328">.</span>Current<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> rawUrl <span style="color:#1f2328">=</span> httpContext<span style="color:#1f2328">.</span>Request<span style="color:#1f2328">.</span>RawUrl<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> returnUrl <span style="color:#1f2328">=</span> rawUrl<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> companyName <span style="color:#1f2328">=</span> ExtractCompanyName<span style="color:#1f2328">(</span>rawUrl<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> companySts <span style="color:#1f2328">=</span> GetCompanySts<span style="color:#1f2328">(</span>companyName<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> realm <span style="color:#1f2328">=</span> GetRealm<span style="color:#1f2328">(</span>companyName<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> redirectUrl <span style="color:#1f2328">=</span> GetRedirectUrl<span style="color:#1f2328">(</span>companySts<span style="color:#1f2328">,</span> realm<span style="color:#1f2328">,</span> returnUrl<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		httpContext<span style="color:#1f2328">.</span>Response<span style="color:#1f2328">.</span>Redirect<span style="color:#1f2328">(</span>redirectUrl<span style="color:#1f2328">,</span> <span style="color:#cf222e">false</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>		httpContext<span style="color:#1f2328">.</span>ApplicationInstance<span style="color:#1f2328">.</span>CompleteRequest<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">string</span> ExtractCompanyName<span style="color:#1f2328">(</span><span style="color:#cf222e">string</span> rawUrl<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> regex <span style="color:#1f2328">=</span> <span style="color:#0a3069">@&#34;~/(.\*?)/.\*&#34;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> relativeUrl <span style="color:#1f2328">=</span> VirtualPathUtility<span style="color:#1f2328">.</span>ToAppRelative<span style="color:#1f2328">(</span>rawUrl<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> match <span style="color:#1f2328">=</span> Regex<span style="color:#1f2328">.</span>Match<span style="color:#1f2328">(</span>relativeUrl<span style="color:#1f2328">,</span> regex<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">return</span> match<span style="color:#1f2328">.</span>Success <span style="color:#1f2328">?</span> match<span style="color:#1f2328">.</span>Groups<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">].</span>Value <span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;&#34;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">string</span> GetCompanySts<span style="color:#1f2328">(</span><span style="color:#cf222e">string</span> companyName<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>companyName <span style="color:#1f2328">==</span> <span style="color:#0a3069">&#34;CompanyA&#34;</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">return</span> <span style="color:#0a3069">@&#34;http://localhost/STS2Site&#34;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">return</span> <span style="color:#0a3069">@&#34;http://localhost/STSSite&#34;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">string</span> GetRealm<span style="color:#1f2328">(</span><span style="color:#cf222e">string</span> companyName<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> realm <span style="color:#1f2328">=</span> <span style="color:#0a3069">@&#34;http://localhost/RPSite/&#34;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">(!</span><span style="color:#cf222e">string</span><span style="color:#1f2328">.</span>IsNullOrEmpty<span style="color:#1f2328">(</span>companyName<span style="color:#1f2328">))</span> realm <span style="color:#1f2328">+=</span> companyName <span style="color:#1f2328">+</span><span style="color:#0a3069">&#34;/&#34;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">return</span> realm<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">string</span> GetRedirectUrl<span style="color:#1f2328">(</span><span style="color:#cf222e">string</span> companySts<span style="color:#1f2328">,</span> <span style="color:#cf222e">string</span> realm<span style="color:#1f2328">,</span> <span style="color:#cf222e">string</span> returnUrl<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">var</span> signInRequestMessage <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> SignInRequestMessage<span style="color:#1f2328">(</span><span style="color:#cf222e">new</span> Uri<span style="color:#1f2328">(</span>companySts<span style="color:#1f2328">),</span> realm<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			Context <span style="color:#1f2328">=</span> returnUrl<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>			HomeRealm <span style="color:#1f2328">=</span> <span style="color:#0a3069">&#34;timvw&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">return</span> signInRequestMessage<span style="color:#1f2328">.</span>WriteQueryString<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div>
			</div>

			<div class="tags">
				
					
						<ul class="flat">
							
							<li><a href="../../../../tags/sts">sts</a></li>
							
							<li><a href="../../../../tags/wif">wif</a></li>
							
						</ul>
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div>2025  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-9DP4SV12YW"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-9DP4SV12YW');
        }
      </script><script>feather.replace()</script>
</body>
</html>
